{% extends 'site_base.html' %}
{% load static %}

{% block pagetitle %}<title>ANcOVA</title>{% endblock pagetitle%}

{% block user %}
    {% if user.is_authenticated %}
        <p>You are logged in as:<br>&nbsp;{{ user.username }}</p>
    {% endif %}
{% endblock user %}

{% block javascript %}
    <style>
        .inlineTable {
            display: inline-block;
            vertical-align: top;
        }
    </style>

    <script type="text/javascript">
        var dataType = 1, treeType = 1, graphType = 1;
        var nodesCat = "", nodesQuant = "", nodesTaxa = "", nodesKEGG = "", nodesNZ = "";
        var taxaAll = 0; var nzAll = 0; var keggAll = 0;
        var chart1 = {}, catOptions = {};
        var chart2 = {}, quantOptions = {};
        var unstackButton = false;
        var running = false, refresh = 0, RID = 0;
        var subset = 'none';
        var HCDefaults = $.extend(true, {}, Highcharts.getOptions(), {});
        var countCat = 0;

        $(function () {
            $(window).load(function() {
                checkButtons();
            });
            $(window).bind('unload', function() {
                $.ajax({
                    url: '/myPhyloDB/removeFiles/',
                    async: false,
                    dataType: 'json',
                    data: {
                        all: RID,
                        func: 'anova'
                    }
                });
            });
            $(".input tr:not(.accordion)").hide();
            $(".input tr.accordion").click(function () {
                var $arrow = $(this).find(".arrow:first");
                $arrow.text($arrow.text() == '►' ? '▼' : '►');
                $(this).nextUntil(".accordion").fadeToggle('fast');
            });
            $(".input tr.accordion:eq(1)").trigger('click');
            $(".input tr.accordion:eq(5)").trigger('click');
        });

        {% include "js/commonFunctions.js" %}
        function barChart(xAxis, yAxis, series) {
            var categories = series[0].data.length;
            var width = categories*100+600;

            catOptions = {
                chart: {
                    renderTo: 'container-1',
                    height: 400,
                    width: width,
                    spacingRight: 50,
                    type: 'column',
                    events: {
                        load: function () {
                            var chart = this, legend = chart.legend;
                            for (var i = 0, len = legend.allItems.length; i < len; i++) {
                                (function (i) {
                                    var item = legend.allItems[i].legendItem;
                                    var color = chart.series[2*i].color;
                                    item.on('mouseover', function (e) {
                                        $(this).qtip({
                                            content: {
                                                text: 'Index: ' + i + '<br>' + 'Color: ' + color
                                            },
                                            style: {
                                                classes: 'qtip-jtools'
                                            },
                                            show: {
                                                ready: true
                                            }
                                        });
                                    });
                                })(i);
                            }

                        }
                    }
                },
                title: { text: null },
                legend: {
                    itemMarginTop: 2,
                    itemStyle: {
                        fontSize: '10px',
                        font: '10pt Trebuchet MS, Verdana, sans-serif',
                        width: 300
                    },
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical',
                    x: -25,
                    y: 25,
                    labelFormatter: function () {
                        var fullName = this.name;
                        if (treeType == 1) {
                            return fullName[0];
                        } else {
                            var lvl = fullName[0].split("|");
                            return lvl[lvl.length - 1] + '<br/>';
                        }
                    }
                },
                xAxis: xAxis,
                yAxis: yAxis,
                series: series,
                tooltip: {
                    formatter: function () {
                        if (this.series.type == 'column') {
                            var lvl = this.series.name[0].split("|");
                            return lvl[lvl.length - 1] + '<br/>' +
                                    'ID: ' + this.series.name[1] + '<br/>' +
                                    'Value: ' + this.y + '<br/>' +
                                    'Total: ' + this.point.stackTotal;
                        } else {
                            return 'standard deviation';
                        }
                    }
                },
                plotOptions: {
                    column: {stacking: "normal"},
                    series: {
                        events: {
                            legendItemClick: function(e) {
                                e.preventDefault();
                                if (this.visible == true) {
                                    this.setVisible(false, false);
                                } else {
                                    this.setVisible(true, false);
                                }
                                errorBars();
                            }
                        },
                        borderWidth: 0
                    }
                },
                credits: { enabled: false }
            };
            chart1 = new Highcharts.Chart(catOptions);
        }
        function checkButtons() {
            dataType = document.getElementById("dataType").value;
            treeType = document.getElementById("selectTree").value;

            $("#run").css("background-color", "lightgray");

            if (dataType == "1") {
                $("#unstackButton").show();
                $("#xDiv").show();
                $("#shapeDiv").hide();

                if (countCat == 1) {
                    $("#reorder").show();
                } else {
                    $("#reorder").hide();
                }
            } else {
                $("#unstackButton").hide();
                $("#xDiv").hide();
                $("#shapeDiv").show();
                $("#reorder").hide();
            }

            if (treeType == "1") {
                $("#tree_taxa").show();
                $("#tree_kegg").hide();
                $("#tree_nz").hide();

                $("#cat_off").show();
                $("#cat_gibbs").hide();
                $("#cat_nitrogen").hide();

                $("#taxDiv").hide();
                $("#taxTableH2").hide();

                $(".map").hide();
                document.getElementById("map_taxa").checked = false;

                $("#row_taxa").show();
                $("#row_kegg").hide();
                $("#row_nz").hide();

                if (dataType == "1") {
                    $("#container-1").empty().show().append('Settings have been changed by the user!');
                    $("#container-2").empty().hide();
                    $("#text-1").empty().show();
                    $("#text-2").empty().hide();
                } else if (dataType == "2") {
                    $("#container-1").empty().hide();
                    $("#container-2").empty().show().append('Settings have been changed by the user!');
                    $("#text-1").empty().hide();
                    $("#text-2").empty().show();
                }
            }

            if (treeType == "2") {
                $("#tree_taxa").hide();
                $("#tree_kegg").show();
                $("#tree_nz").hide();

                $("#cat_off").show();
                $("#cat_gibbs").hide();
                $("#cat_nitrogen").hide();

                $("#row_taxa").hide();
                $("#row_kegg").show();
                $("#row_nz").hide();

                $(".map").show();

                if (dataType == "1") {
                    $("#container-1").empty().show().append('Settings have been changed by the user!');
                    $("#container-2").empty().hide();
                    $("#text-1").empty().show();
                    $("#text-2").empty().hide();
                } else if (dataType == "2") {
                    $("#container-1").empty().hide();
                    $("#container-2").empty().show().append('Settings have been changed by the user!');
                    $("#text-1").empty().hide();
                    $("#text-2").empty().show();
                }
            }

            if (treeType == "3") {
                nzAll = document.getElementById("selectall-nz").value;
                $("#tree_taxa").hide();
                $("#tree_kegg").hide();
                $("#tree_nz").show();

                $("#row_taxa").hide();
                $("#row_kegg").hide();
                $("#row_nz").show();

                $(".map").show();

                if (dataType == "1") {
                    $("#container-1").empty().show().append('Settings have been changed by the user!');
                    $("#container-2").empty().hide();
                    $("#text-1").empty().show();
                    $("#text-2").empty().hide();

                    if (graphType == 1) {
                        if (nzAll == 5) {
                            $("#cat_off").hide();
                            $("#cat_gibbs").show();
                            $("#cat_nitrogen").hide();
                        } else if (nzAll == 6) {
                            $("#cat_off").hide();
                            $("#cat_gibbs").hide();
                            $("#cat_nitrogen").show();
                        } else {
                            $("#cat_off").show();
                            $("#cat_gibbs").hide();
                            $("#cat_nitrogen").hide();
                        }
                    } else {
                        $("#cat_off").show();
                        $("#cat_gibbs").hide();
                        $("#cat_nitrogen").hide();
                    }
                } else if (dataType == "2") {
                    $("#container-1").empty().hide();
                    $("#container-2").empty().show().append('Settings have been changed by the user!');
                    $("#text-1").empty().hide();
                    $("#text-2").empty().show();
                    $("#cat_off").show();
                    $("#cat_gibbs").hide();
                    $("#cat_nitrogen").hide();
                }
            }
            chooseDisplay();
        }
        function chooseData() {
            dataType = document.getElementById("dataType").value;
            treeType = document.getElementById("selectTree").value;
            graphType = document.getElementById("graphDisplay").value;
            if (treeType == 1) {
                taxaAll = document.getElementById("selectall-taxa").value;
                if (dataType == 1) {
                    if ( (nodesCat != "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-1").empty().append('Analysis is running...please be patient');
                        getCatGraphData();
                    } else if ( (nodesCat == "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s) and taxa level(s)!');
                        running = false;
                    } else if ( (nodesCat == "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s)!');
                        running = false;
                    } else if ( (nodesCat != "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your taxa level(s)!');
                        running = false;
                    }
                } else if (dataType == 2) {
                    if ( (nodesQuant != "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-2").empty().append('Analysis is running...please be patient');
                        getQuantGraphData();
                    } else if ( (nodesQuant == "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s) and taxa level(s)!');
                        running = false;
                    } else if ( (nodesQuant == "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s)!');
                        running = false;
                    } else if ( (nodesQuant != "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your taxa level(s)!');
                        running = false;
                    }
                }
            }

            if (treeType == 2) {
                keggAll = document.getElementById("selectall-kegg").value;
                if (dataType == 1) {
                    if ( (nodesCat != "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-1").empty().append('Analysis is running...please be patient');
                        getCatGraphData();
                    } else if ( (nodesCat == "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesCat == "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s)!');
                        running = false;
                    } else if ( (nodesCat != "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                } else if (dataType == 2) {
                    if ( (nodesQuant != "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-2").empty().append('Analysis is running...please be patient');
                        getQuantGraphData();
                    } else if ( (nodesQuant == "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesQuant == "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s)!');
                        running = false;
                    } else if ( (nodesQuant != "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                }
            }

            if (treeType == 3) {
                var nzAll = document.getElementById("selectall-nz").value;
                if (dataType == 1) {
                    if ( (nodesCat != "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-1").empty().append('Analysis is running...please be patient');
                        getCatGraphData();
                    } else if ( (nodesCat == "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesCat == "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s)!');
                        running = false;
                    } else if ( (nodesCat != "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                } else if (dataType == 2) {
                    if ( (nodesQuant != "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-2").empty().append('Analysis is running...please be patient');
                        getQuantGraphData();
                    } else if ( (nodesQuant == "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesQuant == "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s)!');
                        running = false;
                    } else if ( (nodesQuant != "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                }
            }

        }
        function chooseDisplay() {
            dataType = document.getElementById("dataType").value;
            treeType = document.getElementById("selectTree").value;
            graphType = document.getElementById("graphDisplay").value;

            if (graphType == 1) {
                if (dataType == 1) {
                    $("#container-1").show();
                    $("#container-2").hide();
                }
                if (dataType == 2) {
                    $("#container-1").hide();
                    $("#container-2").show();
                }
                $("#container-3").hide();
                $("#highchartButtons").show();
            }
            if (graphType == 2) {
                $("#container-1").hide();
                $("#container-2").hide();
                $("#container-3").show();
                $("#highchartButtons").hide();

                {% static "" as baseUrl %}
                $("#my_image").removeAttr("src").attr("src", "{{ baseUrl }}/temp/anova/Rplots/" + RID +".anova.pdf");
            }
        }
        function colorBox() {
            $("#colorVal").empty().prepend('<option selected="selected" value="None">None</option>');

            $("#colorVal").append('<option value="rank_name">Taxa/KEGG</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'project') || (node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#colorVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#colorVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
        }
        function DepVar() {
            var DepVar = document.getElementById("DepVar").value;
            if (DepVar == 1) {
                $('#transform').empty()
                    .append('<option value="0">None</option>')
                    .append('<option value="3">Sqrt</option>')
                    .append('<option value="4">Logit</option>')
                    .append('<option value="5">Arcsin</option>');
            } else {
                $('#transform').empty()
                    .append('<option value="0" selected>None</option>')
                    .append('<option value="1">Ln</option>')
                    .append('<option value="2">Log10</option>')
                    .append('<option value="3">Sqrt</option>');
            }
            //checkButtons();
        }
        function errorBars() {
            var seriesLen = chart1.series.length;
            var stack = chart1.options.plotOptions.column.stacking;
            if (stack == 'normal') {
                $(chart1.series).each(function () {
                    if (this.type == 'errorbar') {
                        this.setVisible(false, false);
                    }
                });
            } else {
                for (var i = 0; i < seriesLen; i += 2) {
                    if (chart1.series[i].visible) {
                        chart1.series[i + 1].setVisible(true, false);
                    }
                }
            }
            chart1.redraw();
        }
        function exportMap() {
            var file = '../../myPhyloDB/media/temp/anova/Mapped_Taxa.gz';
            window.location.href = file;
            $("#map_export").css("background-color", "green").val("Done!");
        }
        function flipStack() {
            var options = chart1.options;
            if (unstackButton) {
                unstackButton = false;
                document.getElementById("unstackButton").value = "Unstack bars";
                options.plotOptions = {
                    column: {stacking: "normal"},
                    series: {
                        events: {
                            legendItemClick: function(e) {
                                e.preventDefault();
                                if (this.visible == true) {
                                    this.setVisible(false, false);
                                } else {
                                    this.setVisible(true, false);
                                }
                                errorBars();
                            }
                        },
                        borderWidth: 0
                    }
                };
                chart1 = new Highcharts.Chart(options);
            } else {
                unstackButton = true;
                document.getElementById("unstackButton").value = "Stack bars";
                options.plotOptions = {
                    column: {stacking: null},
                    series: {
                        events: {
                            legendItemClick: function(e) {
                                e.preventDefault();
                                if (this.visible == true) {
                                    this.setVisible(false, false);
                                } else {
                                    this.setVisible(true, false);
                                }
                                errorBars();
                            }
                        },
                        borderWidth: 0
                    }
                };
                chart1 = new Highcharts.Chart(options);
            }
            errorBars();
        }
        function getCatGraphData() {
            RID = makeGUID();
            startTimer(RID);
            var arrayValsCat = [];
            var arrayIDsCat = [];
            var arrayValsQuant = [];
            var arrayIDsQuant = [];
            var key = '';
            var value = '';
            var vals = '';
            var id = '';
            var ids = '';
            for (var i = 0; i < nodesQuant.length; i++) {
                if (nodesQuant[i].getLevel() == 5) {
                    if ((nodesQuant[i].data.table == 'mimark') || (nodesQuant[i].data.table == 'user')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
                else if (nodesQuant[i].getLevel() == 6) {
                    if ((nodesQuant[i].data.table == 'human_associated') || (nodesQuant[i].data.table == 'soil') || (nodesQuant[i].data.table == 'air') || (nodesQuant[i].data.table == 'microbial') || (nodesQuant[i].data.table == 'water')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
            }
            for (var i = 0; i < nodesCat.length; i++) {
                if (nodesCat[i].getLevel() == 5) {
                    if ((nodesCat[i].data.table == 'project') || (nodesCat[i].data.table == 'mimark') || (nodesCat[i].data.table == 'user')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
                else if (nodesCat[i].getLevel() == 6) {
                    if ((nodesCat[i].data.table == 'human_associated') || (nodesCat[i].data.table == 'soil') || (nodesCat[i].data.table == 'air') || (nodesCat[i].data.table == 'microbial') || (nodesCat[i].data.table == 'water')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
            }

            if (!checkDupes(arrayValsCat)) {
                clearInterval(refresh);
                $("#run").css("background-color", "lightgray");
                $("#container-1").empty().append('Analysis has been cancelled!');
                alert("Selected meta data only has one level.\nPlease select a different variable.");
            } else {
                var metaValsCat = '';
                if (nodesCat.length > 0) {
                    metaValsCat = "{" + arrayValsCat.join(",") + "}";
                }

                var metaIDsCat = '';
                if (nodesCat.length > 0) {
                    metaIDsCat = "{" + arrayIDsCat.join(",") + "}";
                }

                var metaValsQuant = '';
                if (nodesQuant.length > 0) {
                    metaValsQuant = "{" + arrayValsQuant.join(",") + "}";
                }

                var metaIDsQuant = '';
                if (nodesQuant.length > 0) {
                    metaIDsQuant = "{" + arrayIDsQuant.join(",") + "}";
                }

                var array2 = [];
                for (i = 0; i < nodesTaxa.length; i++) {
                    key = nodesTaxa[i].data.tooltip;
                    value = nodesTaxa[i].data.id;
                    if (nodesTaxa[i].getLevel() >= 2) {
                        var next = '"' + key + '" : "' + value + '"';
                        array2.push(next);
                    }
                }

                var taxa = "{" + array2.join(",") + "}";

                var array3 = [];
                for (i = 0; i < nodesKEGG.length; i++) {
                    key = nodesKEGG[i].data.kegg;
                    value = nodesKEGG[i].data.id;
                    if (nodesKEGG[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array3.push(next);
                    }
                }

                var kegg = "{" + array3.join(",") + "}";

                var array4 = [];
                for (i = 0; i < nodesNZ.length; i++) {
                    key = nodesNZ[i].data.kegg;
                    value = nodesNZ[i].data.id;
                    if (nodesNZ[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array4.push(next);
                    }
                }

                var nz = "{" + array4.join(",") + "}";

                var myDict = {};
                myDict['metaValsCat'] = metaValsCat;
                myDict['metaIDsCat'] = metaIDsCat;
                myDict['metaValsQuant'] = metaValsQuant;
                myDict['metaIDsQuant'] = metaIDsQuant;
                myDict['taxa'] = taxa;
                myDict['kegg'] = kegg;
                myDict['nz'] = nz;
                myDict['RID'] = RID;
                myDict['treeType'] = treeType;
                myDict['colorVal'] = document.getElementById("colorVal").value;
                myDict['xVal'] = document.getElementById("xVal").value;
                myDict['gridVal_X'] = document.getElementById("gridVal_X").value;
                myDict['gridVal_Y'] = document.getElementById("gridVal_Y").value;
                myDict['palette'] = document.getElementById("palette").value;
                myDict['funcName'] = "getCatUnivData";
                myDict['reqType'] = "call";
                myDict['dataID'] = dataID;

                if ($("#remUnclass").is(':checked')) {
                    myDict['remUnclass'] = 'yes'
                } else {
                    myDict['remUnclass'] = 'no'
                }

                if ($("#remZeroes").is(':checked')) {
                    myDict['remZeroes'] = 'yes'
                } else {
                    myDict['remZeroes'] = 'no'
                }

                if ($("#filterData").is(':checked')) {
                    myDict['filterData'] = 'yes'
                } else {
                    myDict['filterData'] = 'no'
                }

                if ($("#map_taxa").is(':checked')) {
                    myDict['map_taxa'] = 'yes'
                } else {
                    myDict['map_taxa'] = 'no'
                }

                myDict['perZeroes'] = document.getElementById("perZeroes").value;
                myDict['filterPer'] = document.getElementById("filterPer").value;
                myDict['filterMeth'] = document.getElementById("filterMeth").value;
                myDict['DepVar'] = document.getElementById("DepVar").value;
                myDict['sig_only'] = document.getElementById("sig_box").checked;
                myDict['selectAll'] = document.getElementById("selectall-taxa").value;
                myDict['keggAll'] = document.getElementById("selectall-kegg").value;
                myDict['nzAll'] = document.getElementById("selectall-nz").value;
                myDict['transform'] = document.getElementById("transform").value;

                var jsonDict = JSON.stringify(myDict);
                $.ajax({
                    type: 'POST',
                    url: '/myPhyloDB/funcCall/',
                    data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}'),
                    success: function (data) {
                        var error = data['error'];
                        if (error != "none") {
                            alert(error);
                            $("#run").css("background-color", "red");
                        }
                    }
                });

            }
        }
        function getQuantGraphData() {
            RID = makeGUID();
            startTimer(RID);
            var arrayValsCat = [];
            var arrayIDsCat = [];
            var arrayValsQuant = [];
            var arrayIDsQuant = [];
            var key = '';
            var value = '';
            var vals = '';
            var id = '';
            var ids = '';
            for (var i = 0; i < nodesQuant.length; i++) {
                if (nodesQuant[i].getLevel() == 5) {
                    if ((nodesQuant[i].data.table == 'mimark') || (nodesQuant[i].data.table == 'user')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
                else if (nodesQuant[i].getLevel() == 6) {
                    if ((nodesQuant[i].data.table == 'human_associated') || (nodesQuant[i].data.table == 'soil') || (nodesQuant[i].data.table == 'air') || (nodesQuant[i].data.table == 'microbial') || (nodesQuant[i].data.table == 'water')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
            }
            for (var i = 0; i < nodesCat.length; i++) {
                if (nodesCat[i].getLevel() == 5) {
                    if ((nodesCat[i].data.table == 'project') || (nodesCat[i].data.table == 'mimark') || (nodesCat[i].data.table == 'user')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
                else if (nodesCat[i].getLevel() == 6) {
                    if ((nodesCat[i].data.table == 'human_associated') || (nodesCat[i].data.table == 'soil') || (nodesCat[i].data.table == 'air') || (nodesCat[i].data.table == 'microbial') || (nodesCat[i].data.table == 'water')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
            }

            if (!checkDupes(arrayValsCat)) {
                clearInterval(refresh);
                $("#run").css("background-color", "lightgray");
                $("#container-1").empty().append('Analysis has been cancelled!');
                alert("Selected meta data only has one level.\nPlease select a different variable.");
            } else {
                var metaValsCat = '';
                if (nodesCat.length > 0) {
                    metaValsCat = "{" + arrayValsCat.join(",") + "}";
                }

                var metaIDsCat = '';
                if (nodesCat.length > 0) {
                    metaIDsCat = "{" + arrayIDsCat.join(",") + "}";
                }

                var metaValsQuant = '';
                if (nodesQuant.length > 0) {
                    metaValsQuant = "{" + arrayValsQuant.join(",") + "}";
                }

                var metaIDsQuant = '';
                if (nodesQuant.length > 0) {
                    metaIDsQuant = "{" + arrayIDsQuant.join(",") + "}";
                }

                var array2 = [];
                for (i = 0; i < nodesTaxa.length; i++) {
                    key = nodesTaxa[i].data.tooltip;
                    value = nodesTaxa[i].data.id;
                    if (nodesTaxa[i].getLevel() >= 2) {
                        var next = '"' + key + '" : "' + value + '"';
                        array2.push(next);
                    }
                }

                var taxa = "{" + array2.join(",") + "}";
                var array3 = [];
                for (i = 0; i < nodesKEGG.length; i++) {
                    key = nodesKEGG[i].data.kegg;
                    value = nodesKEGG[i].data.id;
                    if (nodesKEGG[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array3.push(next);
                    }
                }

                var kegg = "{" + array3.join(",") + "}";

                var array4 = [];
                for (i = 0; i < nodesNZ.length; i++) {
                    key = nodesNZ[i].data.kegg;
                    value = nodesNZ[i].data.id;
                    if (nodesNZ[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array4.push(next);
                    }
                }

                var nz = "{" + array4.join(",") + "}";

                var myDict = {};
                myDict['metaValsCat'] = metaValsCat;
                myDict['metaIDsCat'] = metaIDsCat;
                myDict['metaValsQuant'] = metaValsQuant;
                myDict['metaIDsQuant'] = metaIDsQuant;
                myDict['RID'] = RID;
                myDict['taxa'] = taxa;
                myDict['kegg'] = kegg;
                myDict['nz'] = nz;
                myDict['treeType'] = treeType;
                myDict['colorVal'] = document.getElementById("colorVal").value;
                myDict['shapeVal'] = document.getElementById("shapeVal").value;
                myDict['gridVal_X'] = document.getElementById("gridVal_X").value;
                myDict['gridVal_Y'] = document.getElementById("gridVal_Y").value;
                myDict['palette'] = document.getElementById("palette").value;
                myDict['funcName'] = "getQuantUnivData";
                myDict['reqType'] = "call";
                myDict['dataID'] = dataID;

                if ($("#remUnclass").is(':checked')) {
                    myDict['remUnclass'] = 'yes'
                } else {
                    myDict['remUnclass'] = 'no'
                }

                if ($("#remZeroes").is(':checked')) {
                    myDict['remZeroes'] = 'yes'
                } else {
                    myDict['remZeroes'] = 'no'
                }

                if ($("#filterData").is(':checked')) {
                    myDict['filterData'] = 'yes'
                } else {
                    myDict['filterData'] = 'no'
                }

                if ($("#map_taxa").is(':checked')) {
                    myDict['map_taxa'] = 'yes'
                } else {
                    myDict['map_taxa'] = 'no'
                }

                myDict['perZeroes'] = document.getElementById("perZeroes").value;
                myDict['filterPer'] = document.getElementById("filterPer").value;
                myDict['filterMeth'] = document.getElementById("filterMeth").value;
                myDict['DepVar'] = document.getElementById("DepVar").value;
                myDict['sig_only'] = document.getElementById("sig_box").checked;
                myDict['selectAll'] = document.getElementById("selectall-taxa").value;
                myDict['keggAll'] = document.getElementById("selectall-kegg").value;
                myDict['nzAll'] = document.getElementById("selectall-nz").value;
                myDict['transform'] = document.getElementById("transform").value;

                var jsonDict = JSON.stringify(myDict);

                $.ajax({
                    url: '/myPhyloDB/funcCall/',
                    type: 'POST',
                    data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}'),
                    success: function (data) {
                        var error = data['error'];
                        if (error != "none") {
                            alert(error);
                            $("#run").css("background-color", "red");
                        }
                    }
                });
            }
        }
        function gibbs() {
            var cat_gibbs = $("#GIBBs").val();
            var series = chart1.series;
            var myNames = [];

            for (var i = 0; i < series.length; i++) {

                if (cat_gibbs == '0') {
                    if (series[i].type == 'column') {
                        series[i].setVisible(true, false);
                    } else {
                        if (unstackButton) {
                            series[i].setVisible(true, false);
                        } else {
                            series[i].setVisible(false, false);
                        }
                    }
                } else if (cat_gibbs == '1') {    // decomposition - C
                    myNames = [
                        'bglX: beta-glucosidase',
                        'bglB: beta-glucosidase',
                        'E3.2.1.21: beta-glucosidase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '2') {    // decomposition - N
                    myNames = [
                        'amiE: amidase',
                        'ureC: urease alpha subunit'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '3') {    // decomposition - P
                    myNames = [
                        'phoA: alkaline phosphatase',
                        'phoD: alkaline phosphatase',
                        'E3.1.3.2: acid phosphatase',
                        'appA: acid phosphatase',
                        'phoN: acid phosphatase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '4') {    // decomposition - S
                    myNames = [
                        'aslA: arylsulfatase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '5') {    // N-fixation
                    myNames = [
                        'nifH: nitrogenase Fe protein',
                        'nifDK: nitrogenase Mo-Fe protein'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '6') {    // P solubility
                    myNames = [
                        'pqqC: pyrroloquinoline-quinone synthase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '7') {    // Biocontrol
                    myNames = [
                        'hcnA: glycine dehydrogenase (cyanide-forming)',
                        'budA: acetolactate decarboxylase',
                        'budC: (S,S)-butanediol dehydrogenase',
                        'E3.2.1.6: endo-1,3(4)-beta-gulcanase',
                        'E3.2.1.14: chitinase',
                        'prnD: aminopyrrolnitrin oxygenase',
                        'phlD: phloroglucinol synthase',
                        'ituA: iturin family lipopeptide synthetase A',
                        'fenA: fengycin family lipopeptide synthetase D',
                        'srfAA: surfactin family lipopeptide synthetase A',
                        'rifM: AHBA synthesis associated protein',
                        'phzE: 2-amino-4-deoxychorismate synthase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '8') {    // Root Growth
                    myNames = [
                        'ipdC: indolepyruvate decarboxylase',
                        'acdS: 1-aminocyclopropane-1-carboxylate deaminase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (cat_gibbs == '9') {    // siderophore
                    myNames = [
                        'mbtI: salicylate synthetase',
                        'entA: 2,3-dihydro-2,3-dihydroxybenzoate dehydrogenase',
                        'pchB: isochorismate pyruvate lysase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                }
            }
            chart1.redraw();
        }
        function gridBox() {
            $("#gridVal_X").empty().prepend('<option selected="selected" value="None">None</option>');
            $("#gridVal_Y").empty().prepend('<option selected="selected" value="None">None</option>');

            $("#gridVal_X").append('<option value="rank_name">Taxa/KEGG</option>');
            $("#gridVal_Y").append('<option value="rank_name">Taxa/KEGG</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'project') || (node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#gridVal_X").append('<option value='+title+'>'+title+'</option>');
                            $("#gridVal_Y").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#gridVal_X").append('<option value='+title+'>'+title+'</option>');
                            $("#gridVal_Y").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
        }
        function lineChart(xAxis, yAxis, series) {
            quantOptions = {
                chart: {
                    renderTo: 'container-2',
                    height: 400,
                    width: 850,
                    spacingRight: 50,
                    type: 'scatter',
                    zoomType: 'xy',
                    events: {
                        load: function () {
                            var chart = this,
                                    legend = chart.legend;
                            for (var i = 0, len=legend.allItems.length; i< len; i++) {
                                (function(i) {
                                    var item = legend.allItems[i].legendItem;
                                    var color = chart.series[i].color;
                                    var symbol = chart.series[i].symbol;
                                    var type = chart.series[i].type;
                                    item.on('mouseover', function (e) {
                                        if (type == 'scatter') {
                                            $(this).qtip({
                                                content: {
                                                    text: 'Index: ' + i + '<br>' + 'Color: ' + color + '<br>' + 'Symbol: ' + symbol
                                                },
                                                style: {
                                                    classes: 'qtip-jtools'
                                                },
                                                show: {
                                                    ready: true
                                                }
                                            });
                                        }
                                        if (type == 'line') {
                                            $(this).qtip({
                                                content: {
                                                    text: 'Index: ' + i + '<br>' + 'Color: ' + color
                                                },
                                                style: {
                                                    classes: 'qtip-jtools'
                                                },
                                                show: {
                                                    ready: true
                                                }
                                            });
                                        }
                                    });
                                })(i);
                            }
                        }
                    }
                },
                title: { text: null },
                legend: {
                    itemMarginTop: 2,
                    itemStyle: {
                        fontSize: '10px',
                        font: '10pt Trebuchet MS, Verdana, sans-serif',
                        width: 250
                    },
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical',
                    x: -25,
                    y: 25,
                    labelFormatter: function () {
                        var fullName = this.name;
                        if (treeType == 1) {
                            return fullName;
                        } else {
                            if (this.type != 'line') {
                                var lvl = fullName.split("|");
                                return lvl[lvl.length - 1];
                            } else {
                                return fullName;
                            }
                        }
                    }
                },
                xAxis: xAxis,
                yAxis: yAxis,
                series: series,
                tooltip: {
                    formatter: function () {
                        if (this.point.name == undefined) {
                            return this.series.name
                        } else {
                            return this.point.name + '<br/>' + '(' + this.x + ',' + this.y + ')'
                        }
                    }
                },
                credits: { enabled: false }
            };
            chart2 = new Highcharts.Chart(quantOptions);
        }
        function ncycle() {
            var ncycle = $("#N_cycle").val();
            var series = chart1.series;
            var myNames = [];

            for (var i = 0; i < series.length; i++) {
                series[i].setVisible(false, false);

                if (ncycle == '0') {
                    if (series[i].type == 'column') {
                        series[i].setVisible(true, false);
                    } else {
                        if (unstackButton) {
                            series[i].setVisible(true, false);
                        } else {
                            series[i].setVisible(false, false);
                        }
                    }
                } else if (ncycle == '1') {    // N-fixation
                    myNames = [
                        'nifH: nitrogenase Fe protein',
                        'nifDK: nitrogenase Mo-Fe protein'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (ncycle == '2') {    // Ammonification
                    myNames = [
                        'amiE: amidase',
                        'ureC: urease alpha subunit'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (ncycle == '3') {    // Nitrification
                    myNames = [
                        'pmoA-amoA: methane/ammonia monooxygenase',
                        'hao: hydroxylamine dehydrogenase',
                        'narGH: nitrate reductase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (ncycle == '4') {    // DNRA
                    myNames = [
                        'nirBD: nitrite reductase (NADH)',
                        'nrfA: nitrite reductase (cytochrome c-552)'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (ncycle == '5') {    // ANRA
                    myNames = [
                        'nirA: ferrodoxin-nitrite reductase',
                        'NIT-6: nitrite reductase (NAD(P)H)'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                } else if (ncycle == '6') {    // Denitrification
                    myNames = [
                        'nirK: nitrite reductase (NO forming)',
                        'nirS:  nitrite reductase (NO forming)',
                        'norBC: nitric oxide reductase',
                        'nosZ: nitrous-oxide reductase'
                    ];
                    if (myNames.indexOf(series[i].name[0]) !== -1) {
                        if (series[i].type == 'column') {
                            series[i].setVisible(true, false);
                        } else {
                            if (unstackButton) {
                                series[i].setVisible(true, false);
                            } else {
                                series[i].setVisible(false, false);
                            }
                        }
                    } else {
                        series[i].setVisible(false, false);
                    }
                }
            }
            chart1.redraw();
        }
        function reOrder() {
            var pos1 = prompt("Please enter the x-axis position you wish to move from:", 0);
            var pos2 = prompt("Please enter the x-axis position you wish to move to:", 1);
            var cat = chart1.xAxis[0].categories;
            swapElement(cat, pos1, pos2);
            chart1.xAxis[0].setCategories(cat);
            // this takes an alarming amount of time
            var seriez = chart1.series;
            for (var i=0; i < seriez.length; i++) {
                var dat = chart1.series[i];
                var arr = dat.options.data;
                swapElement(arr, pos1, pos2);
                chart1.series[i].update({
                    data: arr
                });
            }
        }
        function runAnalysis() {
            if (running == true) {
                alert("myPhyloDB is currently running your previous analysis request!");
                return false;
            }
            $("#my_image").attr("src", "#");
            $("#Export").val('Export Data').css('background-color', 'lightgray');
            $("#map_export").attr('disabled', true).css('background-color', 'lightgray');
            $("#graphDisplay").val("1");

            if (dataType == 1) {
                $("#container-3").hide();
                $("#container-1").empty().show();
                $("#text-1").val('');
            }
            if (dataType == 2) {
                $("#container-3").hide();
                $("#container-2").empty().show();
                $("#text-2").val('');
            }

            $("#taxDiv").empty();

            running = true;
            checkButtons();
            chooseData();
        }
        function selectAnalysis() {
            if (dataType == 1) {
                $("#tree_metaQuant").show();
                $("#tree_metaCat").show();
                $("#container-2").hide();
                $("#container-1").show();
                $("#text-1").show();
                $("#text-2").hide();
            }
            else if (dataType == 2) {
                $("#tree_metaCat").show();
                $("#tree_metaQuant").show();
                $("#container-1").hide();
                $("#container-2").show();
                $("#text-1").hide();
                $("#text-2").show();
            }
            checkButtons();
        }
        function selectAll(val) {
            if (val == 5) {
                subset = 'gibbs'
            } else if (val == 6) {
                subset = 'ncycle'
            } else {
                subset = 'none'
            }
            clearTaxa();
            //checkButtons();
        }
        function selectTree() {
            treeType = document.getElementById("selectTree").value;

            if (treeType == 1) {
                $('#tree_taxa').show().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#tree_kegg').hide().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#tree_nz').hide().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#row_taxa').show();
                $('#row_kegg').hide();
                $('#row_nz').hide();
                $('#text-1').val('');
                $('#text-2').val('');
                $('.map').hide();
            } else if (treeType == 2) {
                $('#tree_taxa').hide().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#tree_kegg').show().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#tree_nz').hide().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#row_taxa').hide();
                $('#row_kegg').show();
                $('#row_nz').hide();
                $('#text-1').val('');
                $('#text-2').val('');
                $('.map').show();
            } else if (treeType == 3) {
                $('#tree_taxa').hide().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#tree_kegg').hide().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#tree_nz').show().dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $('#row_taxa').hide();
                $('#row_kegg').hide();
                $('#row_nz').show();
                $('#text-1').val('');
                $('#text-2').val('');
                $('.map').show();
            }
        }
        function shapeBox() {
            $("#shapeVal").empty()
                    .prepend('<option selected="selected" value="None">None</option>');

            $("#shapeVal").append('<option value="rank_name">Taxa/KEGG</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'project') || (node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#shapeVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#shapeVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
        }
        function stopAnalysis() {
            running = false;
            clearInterval(refresh);
            $.ajax({
                url: '/myPhyloDB/stop/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: RID
                },
                success: function (data) {
                    $("#run").css("background-color", "red");
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var stage = obj['message'];
                    if (dataType == 1) {
                        $('#container-1').empty().append(stage);
                    } else if (dataType == 2) {
                        $('#container-2').empty().append(stage);
                    }
                }
            });
        }
        function swapElement(array, indexA, indexB) {
            var tmp = array[indexA];
            array[indexA] = array[indexB];
            array[indexB] = tmp;
        }
        function updateStatus() {
            var myDict = {};
            myDict['reqType'] = "status";
            myDict['RID'] = RID;
            myDict['funcName'] = "anovaStatus";
            var jsonDict = JSON.stringify(myDict);
            $.ajax({
                url: '/myPhyloDB/funcCall/',
                type: 'POST',
                data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}'),
                success: function (data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var resType = obj['resType'];
                    if (resType == "status") {
                        var stage = obj['stage'];
                        if (running) {
                            if (stage != "Downloading results") {   // this was a temp fix made permanent
                                // the idea being that the downloading results screen can overwrite the actual results
                                // if requests are returned out of sequence
                                // could set a global flag when actual results are acquired, preventing this step (?)
                                if (dataType == 1) {
                                    $('#container-1').empty().append(stage);
                                } else if (dataType == 2) {
                                    $('#container-2').empty().append(stage);
                                }
                            }
                        }
                    } else {
                        clearInterval(refresh);
                        running = false;
                        var xAxis = data['xAxis'];
                        var series = data['series'];
                        var yAxis = data['yAxis'];
                        var empty = data['empty'];
                        var error = data['error'];
                        if (error != "none") {
                            alert(error);
                            $("#run").css("background-color", "red");
                            $("#container-1").empty();
                            return
                        } else {
                            $("#run").css("background-color", "green");
                        }

                        var text = data['text'];

                        if (document.getElementById("dataType").value == 1) {
                            if (empty == 0) {
                                $("#container-1").empty().append('No significant tests!');
                            } else {
                                barChart(xAxis, yAxis, series);
                            }
                            $('#text-1').val(text);

                        } else {
                            if (empty == 0) {
                            $("#container-2").empty().append('No significant regressions!');
                            } else {
                                lineChart(xAxis, yAxis, series);
                            }
                            $('#text-2').val(text);
                        }

                        if ($("#map_taxa").is(':checked')) {
                            $("#map_export").attr('disabled', false);
                        }
                    }

                }
            });
        }
        function xBox() {
            $("#xVal").empty().prepend('<option selected="selected" value="None">None</option>');

            $("#xVal").append('<option value="rank_name">Taxa/KEGG</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'project') || (node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#xVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#xVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
        }

    </script>
{% endblock javascript %}

{% block my_content %}
    <br>
    <div>
        <table border="2" cellspacing="0" cellpadding="5" class="inlineTable">
            <tr style="height: 40px;">
                <th>Select Meta Data:<br>
                    <a href="#" id="clearMeta" style="font-size: 12px;" onClick="clearMeta()">-Deselect all-</a>
                </th>
            </tr>
            <tr>
                <td style="padding-right: 10px; vertical-align: top">
                    {% include "html/DynaTree-MetaCat.html" %}
                    {% include "html/DynaTree-MetaQuant.html" %}
                </td>
            </tr>
        </table>

        <table border="2" cellspacing="0" cellpadding="5" class="inlineTable" style="margin-left:10px;">
            <tr style="height: 40px;">
                <th>Select Response Variable:<br>
                    <a href="#" id="clearTaxa" style="font-size: 12px;" onClick="clearTaxa()">-Deselect all-</a>
                </th>
            </tr>
            <tr>
                <td style="padding-right: 10px; vertical-align: top">
                    {% include "html/DynaTree-Response.html" %}
                </td>
            </tr>
        </table>

        <table border="0" cellspacing="0" cellpadding="5" class="inlineTable input" style="table-layout: fixed">
            <tr class="accordion">
                <td bgcolor="white" width="5px"></td>
                <td colspan="2" bgcolor="lightgray"  style="outline: thin solid"><strong><em><span class="arrow">►</span> Analysis Type:</em></strong></td>
            </tr>
            <tr>
                <td bgcolor="white" width="5px"></td>
                <td bgcolor="white">
                    <select id="dataType" onChange="selectAnalysis()">
                        <option value="1" selected="selected">Bar plot (factors)</option>
                        <option value="2" >Scatter plot (regression)</option>
                    </select>
                    &nbsp; <-- Displayed graph
                </td>
                <td bgcolor="white"></td>
            </tr>
            <tr><td colspan="3" bgcolor="white"></td></tr>
            <tr class="accordion">
                <td bgcolor="white" width="5px"></td>
                <td colspan="2" bgcolor="lightgray"  style="outline: thin solid"><strong><em><span class="arrow">►</span> Data Selection:</em></strong></td>
            </tr>

            <tr>
                <td bgcolor="white" width="5px"></td>
                <td bgcolor="white">
                    <select id="selectTree" onChange="selectTree()">
                        <option value="1" selected="selected">Taxonomy</option>
                        <option value="2" >KEGG orthology</option>
                        <option value="3" >KEGG enzyme</option>
                    </select>
                    &nbsp; <-- Sequence mapping
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white" width="5px"></td>
                <td id="row_taxa" bgcolor="white">
                    <select id="selectall-taxa" onChange="selectTree()">
                        <option value="0">None</option>
                        <option value="2">Phyla</option>
                        <option value="3">Classes</option>
                        <option value="4">Orders</option>
                        <option value="5">Families</option>
                        <option value="6">Genera</option>
                        <option value="7">Species</option>
                        <option value="9" selected="selected">OTU_99</option>
                        <option value="8">PGPRs</option>
                    </select>
                    &nbsp; <-- Taxa level
                </td>
                <td  id="row_kegg" bgcolor="white" style="display:none">
                    <select id="selectall-kegg" onChange="checkButtons()">
                        <option value="0">None</option>
                        <option value="1" selected="selected">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                    </select>
                    &nbsp; <-- KEGG pathway level
                </td>
                <td id="row_nz" bgcolor="white" style="display:none">
                    <select id="selectall-nz" onChange="checkButtons()">
                        <option value="0">None</option>
                        <option value="1" selected="selected">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">GIBBs</option>
                        <option value="6">N cycle</option>
                    </select>
                    &nbsp; <-- KEGG enzyme level
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white" width="5px"></td>
                <td bgcolor="white">
                    <select id="DepVar" onChange="DepVar()">
                        <option value="0" selected="selected">Abundance</option>
                        <option value="1">Relative Abundance</option>
                        <option value="4">Total Abundance</option>
                        <option value="2">OTU Richness</option>
                        <option value="3">OTU Diversity</option>
                    </select>
                &nbsp; <-- Dependent variable <span title="Abundance = number of sequence reads<br>Relative Abundance = proportion of total community<br>Total Abundance = 16S rRNA copies per mg soil<br>OTU Richness = number of OTUs<br>OTU Diversity = Shannon's Diversity Index"><font class="info" color="red">[info]</font></span>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white" width="5px"></td>
                <td bgcolor="white">
                    <select id="transform" onChange="checkButtons()">
                        <option value="0" selected="selected">None</option>
                        <option value="1">Ln</option>
                        <option value="2">Log10</option>
                        <option value="3">Sqrt</option>
                        <!--<option value="4">Logit</option>
                        <option value="5">Arcsin</option>-->
                    </select>
                    &nbsp; <-- Raw data transformation
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white" width="5px"></td>
                <td id="sig_text" bgcolor="white">
                    <input type="checkbox" id="sig_box" onChange="checkButtons()">
                    &nbsp; <-- Display only significant tests (p &#8804 0.05)
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr><td colspan="3" bgcolor="white"></td></tr>
            {% include "html/Data-Filtering.html" %}

            <tr><td colspan="3" bgcolor="white"></td></tr>
            <tr class="accordion map">
                <td bgcolor="white" width="5px"></td>
                <td colspan="2" bgcolor="lightgray"  style="outline: thin solid"><strong><em><span class="arrow">►</span> Map Taxa to KEGG Pathway/Enzyme:</em></strong></td>
            </tr>
            <tr>
                <td bgcolor="white" width="5px"></td>
                <td id="sig_text" bgcolor="white">
                    <input type="checkbox" id="map_taxa" onChange="checkButtons()">
                    &nbsp; <-- Save mapped taxa &nbsp;&nbsp;
                    <input id="map_export" disabled type="button" value="Export Data" onClick="exportMap()"/>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr><td colspan="3" bgcolor="white"></td></tr>
            <tr class="accordion">
                <td bgcolor="white" width="5px"></td>
                <td colspan="2" bgcolor="lightgray" style="outline: thin solid"><strong><em><span class="arrow">►</span> Optimize R plot:</em></strong></td>
            </tr>

            <tr>
                <td bgcolor="white"></td>
                <td bgcolor="white">
                    <div style="background-color: white">
                        <select id="palette" onChange="checkButtons()">
                            <option value="Set1">Set1</option>
                            <option value="Set2">Set2</option>
                            <option value="Set3">Set3</option>
                            <option value="Paired">Paired</option>
                            <option value="Dark2">Dark2</option>
                            <option value="Accent">Accent</option>
                            <option value="gdocs">Google</option>
                            <option value="hc">Highcharts</option>
                        </select>
                        &nbsp; <-- Color palette for symbol colors
                    </div>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white"></td>
                <td bgcolor="white">
                    <div style="background-color: white">
                        <select id="gridVal_X" onChange="checkButtons()">
                            <option value="None">None</option>
                        </select>
                        &nbsp; <-- Grouping variable for graph panels (horizontal)
                    </div>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white"></td>
                <td bgcolor="white">
                    <div style="background-color: white">
                        <select id="gridVal_Y" onChange="checkButtons()">
                            <option value="None">None</option>
                        </select>
                        &nbsp; <-- Grouping variable for graph panels (vertical)
                    </div>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white"></td>
                <td bgcolor="white">
                    <div id="xDiv" style="background-color: white">
                        <select id="xVal" onChange="checkButtons()">
                            <option value="None">None</option>
                        </select>
                        &nbsp; <-- Grouping variable for X-axis
                    </div>
                    <div id="shapeDiv" style="background-color: white">
                        <select id="shapeVal" onChange="checkButtons()">
                            <option value="None">None</option>
                        </select>
                        &nbsp; <-- Grouping variable for symbol shapes
                    </div>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr>
                <td bgcolor="white"></td>
                <td bgcolor="white">
                    <div style="background-color: white">
                        <select id="colorVal" onChange="checkButtons()">
                            <option value="None">None</option>
                        </select>
                        &nbsp; <-- Grouping variable for colors
                    </div>
                </td>
                <td bgcolor="white"></td>
            </tr>

            <tr style="display:none"><td colspan="3" bgcolor="white"></td></tr>
            {% include "html/Data-RunButton.html" %}
            <tr><td colspan="3" bgcolor="white"></td></tr>
            {% include "html/Data-Export.html" %}
        </table>

    </div>
    <br><br>

    <table width="950px" border="2" style="table-layout: fixed">
        <colgroup>
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
        </colgroup>
        <tr>
            <th colspan="20" style="padding-right: 10px;">GraphData</th>
        </tr>
        <tr>
            <td colspan="6" style="text-align: center;">
                <input type="button" id="reorder" value="Reorder bars" onclick="reOrder();">
                <input type="button" id="unstackButton" value="Unstack bars" onclick="flipStack();">
            </td>

            <td id="cat_off" colspan="8" style="text-align: center"></td>
            <td id="cat_gibbs" colspan="8" style="text-align: center; display: none">
                Category:
                <select id="GIBBs" onChange="gibbs()">
                    <option value="0" selected="selected">All</option>
                    <option value="1">C decomposition</option>
                    <option value="2">N decomposition</option>
                    <option value="3">P decomposition</option>
                    <option value="4">S decomposition</option>
                    <option value="5">Nitrogen fixation</option>
                    <option value="6">Phosphate solubility</option>
                    <option value="7">Biocontrol</option>
                    <option value="8">Root growth</option>
                    <option value="9">Siderophore</option>
                </select>
            </td>

            <td id="cat_nitrogen" colspan="8" style="text-align: center; display: none">
                Category:
                <select id="N_cycle" onChange="ncycle()">
                    <option value="0" selected="selected">All</option>
                    <option value="1">Nitrogen fixation</option>
                    <option value="2">Ammonification</option>
                    <option value="3">Nitrification</option>
                    <option value="4">Dissimilatory nitrate reduction (DNR)</option>
                    <option value="5">Assimilatory nitrate reduction (ANR)</option>
                    <option value="6">Denitrification</option>
                </select>
            </td>

            <td colspan="6" style="text-align: center">
                Display graph:
                <select id="graphDisplay" onChange="chooseDisplay()">
                    <option value="1">Highcharts</option>
                    <option value="2">R plot</option>
                </select>
            </td>

        </tr>

        <tr>
            <td colspan="20" style="text-align: left">
                <div id="container-1" style="height: 425px; width: 935px; overflow-x: auto;">No Data has been selected!</div>
                <div id="container-2" style="height: 425px; width: 935px; overflow-x: auto; display: none">No Data has been selected!</div>
                <div id="container-3" style="height: 650px; width: 935px; display:none"><iframe id="my_image" src="#" height="100%" width="100%"></iframe></div>
            </td>
        </tr>
        <tr id="highchartButtons">
            {% include "html/HighChart-HideButton.html" %}
            {% include "html/HighChart-ThemeButton.html" %}
            {% include "html/HighChart-ChangeButton.html" %}
        </tr>
    </table>

    <div id="txt-1">
        <h2>Test Results:</h2>
        <textarea style="width: 950px;" wrap="off" id="text-1" rows="20">No data selected</textarea>
        <textarea style="width: 950px; display: none" wrap="off" id="text-2" rows="20">No data selected</textarea>
        <br>
    </div>
    <br><br>
    <br><br><br><br>

{% endblock my_content%}
