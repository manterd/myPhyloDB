{% extends 'base.html' %}
{% load static %}

{% block pagetitle %}
    <title>ANcOVA</title>
{% endblock pagetitle%}

{% block user %}
    {% if user.is_authenticated %}
        <p>You are logged in as:<br>&nbsp;{{ user.username }}</p>
    {% endif %}
{% endblock user %}

{% block menu_item %}{% endblock menu_item %}

{% block javascript %}
    <style>
        .inlineTable {
            display: inline-block;
            vertical-align: top;
        }
    </style>

    <script type="text/javascript">

        var button1 = 1, selTheme = 0, i = 0, unstackButton = false;
        var nodesCat = "", nodesQuant = "", nodesTaxa = "", nodesKEGG = "", nodesNZ = "";
        var chart1 = {}, chart2 = {};
        var catOptions = {}, quantOptions = {};
        var refresh = 0;
        var running = false;
        var RID = 0;
        var button3 = 1;
        var cat_gibbs = 0, cat_n = 0;

        $(function () {

            // Remove temporary files from previous analysis
            $(window).bind('beforeunload', function() {
                $.ajax({
                    url: '/myPhyloDB/removeFiles/',
                    async: false,
                    dataType: 'json',
                    data: {
                        all: RID,
                        func: 'anova'
                    }
                });
            });

            // Initialize DynaTrees
            {% include "js/metaCatTree.html" %}
            {% include "js/metaQuantTree.html" %}
            {% include "js/TaxaTree.html" %}
            {% include "js/KEGGTree.html" %}
            {% include "js/NZTree.html" %}

            // Initialize HighCharts
            Highcharts.setOptions({
                lang: {
                    numericSymbols: [' × 10³', ' × 10⁶', ' × 10⁹', ' × 10¹²', ' × 10¹⁵', ' × 10¹⁸']
                }
            });
            {% include "html/HideSeries.html" %}
            {% include "html/ChangeSeries.html" %}

            // Start stop and other 'click' functions
            $("#run").show().click(function() {
                if(running == true) {
                    alert("myPhyloDB is currently running your previous analysis request!");
                    return false;
                }
                $("#container-1").empty();
                $("#container-2").empty();
                $("#text-1").val('');
                $("#text-2").val('');
                running = true;
                checkButtons();
                chooseData();
            });

            $("#stop").show().click(function () {
                running = false;
                stopThis(RID);
            });

            $("#clearMeta").click(function () {
                if (button1 == 1) {
                    $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                }
                else if (button1 == 2) {
                    $("#tree_metaQuant").dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                }
                $("#run").css("background-color", "lightgray");
            });

            $("#clearTaxa").click(function () {
                $("#selectall-taxa").val(0);
                $("#selectall-kegg").val(0);
                $("#selectall-nz").val(0);

                $("#tree_taxa").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $("#tree_kegg").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $("#tree_nz").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });

                $("#run").css("background-color", "lightgray");
            });

            $("#remUnclass").click(function () {
                checkButtons();
            });

            $("#remZeroes").click(function () {
                checkButtons();
            });

            $("#filterData").click(function () {
                checkButtons();
            });

            $("#filterMeth").click(function () {
                checkButtons();
            });

            $("#TabButton").click(function () {
                getTab();
            });

            // capture all changed in textboxes, etc.
            $("#button1").change(function () {
                button1 = $(this).val();
                chooseDisplay();
                checkButtons();
            });

            $("#selectTree").change(function () {
                button3 = $(this).val();
                checkButtons();
                if (button3 == 1) {
                    $('#tree_taxa').show().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#tree_kegg').hide().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#tree_nz').hide().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#row_taxa').show();
                    $('#row_kegg').hide();
                    $('#row_nz').hide();
                    $('#text-1').val('');
                    $('#text-2').val('');
                } else if (button3 == 2) {
                    $('#tree_taxa').hide().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#tree_kegg').show().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#tree_nz').hide().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#row_taxa').hide();
                    $('#row_kegg').show();
                    $('#row_nz').hide();
                    $('#text-1').val('');
                    $('#text-2').val('');
                } else if (button3 == 3) {
                    $('#tree_taxa').hide().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#tree_kegg').hide().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#tree_nz').show().dynatree("getRoot").visit(function (node) {
                        node.select(false);
                    });
                    $('#row_taxa').hide();
                    $('#row_kegg').hide();
                    $('#row_nz').show();
                    $('#text-1').val('');
                    $('#text-2').val('');
                }
            });

            $("#GIBBs").change(function() {
                cat_gibbs = $(this).val();
                gibbs();

            });

            $("#N_cycle").change(function() {
                cat_n = $(this).val();
                ncycle();
            });

            $("#theme").change(function () {
                selTheme = $(this).val();

                if (selTheme == 1) {
                    if (button1 == 1) {
                        $("#container-1").empty();
                        chart1 = new Highcharts.Chart(catOptions);
                        chart1.redraw();
                    }
                    else if (button1 == 2) {
                        $("#container-2").empty();
                        chart2 = new Highcharts.Chart(quantOptions);
                        chart2.redraw();
                    }
                }
                else if (selTheme == 2) {
                    $.getScript('{% static 'highcharts/themes/dark-blue.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 3) {
                    $.getScript('{% static 'highcharts/themes/dark-green.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 4) {
                    $.getScript('{% static 'highcharts/themes/dark-unica.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 5) {
                    $.getScript('{% static 'highcharts/themes/gray.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 6) {
                    $.getScript('{% static 'highcharts/themes/grid.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 7) {
                    $.getScript('{% static 'highcharts/themes/grid-light.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 8) {
                    $.getScript('{% static 'highcharts/themes/sand-signika.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
                else if (selTheme == 9) {
                    $.getScript('{% static 'highcharts/themes/skies.js' %}', function () {
                        if (button1 == 1) {
                            $("#container-1").empty();
                            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                            chart1.redraw();
                        }
                        else if (button1 == 2) {
                            $("#container-2").empty();
                            chart2 = new Highcharts.Chart(Highcharts.merge(quantOptions, theme));
                            chart2.redraw();
                        }
                    });
                }
            });

            // on load functions
            $(window).load(function() {
                checkButtons();
            });

        });

        function getTab() {
            $("#TabButton").css("background-color", "yellow").val("Gathering your data...please wait!");
            $.ajax({
                url: '/myPhyloDB/getRawData/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: RID,
                    func: 'anova',
                    button3: button3
                },
                success: function(data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var name = obj['name'];
                    getFile(name, 'final_data.csv');
                    $("#TabButton").css("background-color", "green").val("Done!");
                }
            });
        }

        function flipStack() {
            if (unstackButton) {
                unstackButton = false;
                document.getElementById("unstackButton").value = "Unstack bars";

                $("#container-1").empty();
                catOptions.plotOptions.column.stacking = "normal";
                chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
                chart1.redraw();
                return;
            }
            unstackButton = true;
            document.getElementById("unstackButton").value = "Stack bars";

            $("#container-1").empty();
                catOptions.plotOptions.column.stacking = null;
            chart1 = new Highcharts.Chart(Highcharts.merge(catOptions, theme));
            chart1.redraw();
        }

        function getFile(name, final) {
            var anchor = document.createElement('a');
            anchor.setAttribute('href', name);
            anchor.setAttribute('download', final);

            var ev = document.createEvent("MouseEvents");
                ev.initMouseEvent("click", true, false, self, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            anchor.dispatchEvent(ev);
        }

        function ncycle() {
            var series = chart1.series;
            if (cat_n == 0) {    // All
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(true, false);
                }
            } else if (cat_n == 1) {    // N-fixation
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[1].setVisible(true, false);  // 1.18.6.1  nitrogenase
            } else if (cat_n == 2) {    // Ammonification
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[16].setVisible(true, false);  // 3.5.1.4  amidase
                series[17].setVisible(true, false);  // 3.5.1.5  urease
            } else if (cat_n == 3) {    // nitrification
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[0].setVisible(true, false);  // 1.14.99.39  ammonia monooxygenase
                series[9].setVisible(true, false);  // 1.7.2.6  hydroxylamine dehydrogenase
                series[15].setVisible(true, false);  // 1.7.99.4  nitrate reductase
            } else if (cat_n == 4) {    // DNRA
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[12].setVisible(true, false);  // 1.7.5.1  nitrate reductase (quinone)
                series[15].setVisible(true, false);  // 1.7.99.4  nitrate reductase
                series[3].setVisible(true, false);  // 1.7.1.15  nitrite reductase (NADH)
                series[6].setVisible(true, false);  // 1.7.2.2  nitrite reductase (cytochrome; ammonia-forming)
            } else if (cat_n == 5) {    // ANRA
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[13].setVisible(true, false);  // 1.7.7.1  ferredoxin---nitrite reductase
                series[14].setVisible(true, false);  // 1.7.7.2  ferredoxin---nitrate reductase
                series[15].setVisible(true, false);  // 1.7.99.4  nitrate reductase
                series[4].setVisible(true, false);  // 1.7.1.4  nitrite reductase [NAD(P)H]
                series[2].setVisible(true, false);  // 1.7.1.1  nitrate reductase (NADH)
            } else if (cat_n == 6) {    // denitrification
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[15].setVisible(true, false);  // 1.7.99.4  nitrate reductase
                series[5].setVisible(true, false);  // 1.7.2.1  nitrite reductase (NO-forming)
                series[8].setVisible(true, false);  // 1.7.2.5  nitric oxide reductase (cytochrome c)
                series[7].setVisible(true, false);  // 1.7.2.4  nitrous-oxide reductase
            } else if (cat_n == 7) {    // anammox
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[10].setVisible(true, false);  // 1.7.2.7  hydrazine synthase
                series[11].setVisible(true, false);  // 1.7.2.8  hydrazine dehydrogenase
            }
            chart1.redraw();
        }

        function gibbs() {
            var series = chart1.series;
            if (cat_gibbs == 0) {
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(true, false);
                }
            } else if (cat_gibbs == 1) {    // decomposition - C
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[10].setVisible(true, false);  //# 3.2.1.4  cellulase
                series[13].setVisible(true, false);  //# 3.2.1.91  cellulose 1,4-beta-cellobiosidase (non-reducing end)
                series[8].setVisible(true, false);  //# 3.2.1.21  beta-glucosidase
                series[12].setVisible(true, false);  //# 3.2.1.8  endo-1,4-beta-xylanase
                series[9].setVisible(true, false);  //# 3.2.1.37  xylan 1,4-beta-xylosidase
            } else if (cat_gibbs == 2) {    // decomposition - N
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[14].setVisible(true, false);  //# 3.5.1.4  amidase
                series[15].setVisible(true, false);  //# 3.5.1.5  urease
            } else if (cat_gibbs == 3) {    // decomposition - P
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[4].setVisible(true, false);  //# 3.1.3.1  alkaline phosphatase
                series[5].setVisible(true, false);  //# 3.1.3.2  acid phosphatase
            } else if (cat_gibbs == 4) {    // decomposition - S
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[6].setVisible(true, false);  //# 3.1.6.1  arylsulfatase
            } else if (cat_gibbs == 5) {    // N-fixation
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[1].setVisible(true, false);  //# 1.18.6.1  nitrogenase
            } else if (cat_gibbs == 6) {    // P solubility
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[2].setVisible(true, false);  //# 1.3.3.11  pyrroloquinoline-quinone synthase
            } else if (cat_gibbs == 7) {    // Biocontrol
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[3].setVisible(true, false);  //# 1.4.99.5  glycine dehydrogenase (cyanide-forming)
                series[17].setVisible(true, false);  //# 4.1.1.5  acetolactate decarboxylase
                series[0].setVisible(true, false);  //# 1.1.1.76  (S,S)-butanediol dehydrogenase
                series[11].setVisible(true, false);  //# 3.2.1.6  endo-1,3(4)-beta-glucanase
                series[7].setVisible(true, false);  //# 3.2.1.14  chitinase
            } else if (cat_gibbs == 8) {    // Root growth
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[18].setVisible(true, false);  //# 4.1.1.74  indolepyruvate decarboxylase
                series[16].setVisible(true, false);  //# 3.5.99.7  1-aminocyclopropane-1-carboxylate deaminase
            } else if (cat_gibbs == 9) {    // Siderophore
                for (var i = 0; i < series.length; i++) {
                    series[i].setVisible(false, false);
                }
                series[19].setVisible(true, false);  //# 6.3.2.39  aerobactin synthase
                series[20].setVisible(true, false);  //# 6.3.2.14  enterobactin synthase
                series[21].setVisible(true, false);  //# K04787 mycobactin salicyl-AMP ligase [EC:6.3.2.-]
                series[22].setVisible(true, false);  //# K04783 yersiniabactin salicyl-AMP ligase [EC:6.3.2.-]
            }
            chart1.redraw();
        }

        function checkButtons() {
            // get state of all buttons used here before proceeding

            // taxa kegg nz select
            var treeType = document.getElementById("selectTree").value;
            button3 = treeType;

            // cat quant select
            var dataType = document.getElementById("button1").value;
            button1 = dataType;

            // set all menus and buttons to their proper states given the current state
            // of the independent (saved to cache) buttons
            $("#run").css("background-color", "lightgray");
            $("#TabButton").css("background-color", "lightgray").val("Export Data");
            document.getElementById("TabButton").disabled = true;

            if (dataType == "1") {
                $("#unstackButton").show();
            } else {
                $("#unstackButton").hide();
            }

            if (treeType == "1") {

                $("#tree_taxa").show();
                $("#tree_kegg").hide();
                $("#tree_nz").hide();

                $("#cat_off").show();
                $("#cat_gibbs").hide();
                $("#cat_nitrogen").hide();

                $("#taxDiv").hide();
                $("#taxTableH2").hide();

                if (dataType == "1") {
                    $("#container-1").empty().show().append('Settings have been changed by the user!');
                    $("#container-2").empty().hide();
                    $("#text-1").empty().show();
                    $("#text-2").empty().hide();
                } else if (dataType == "2") {
                    $("#container-1").empty().hide();
                    $("#container-2").empty().show().append('Settings have been changed by the user!');
                    $("#text-1").empty().hide();
                    $("#text-2").empty().show();
                }
            }

            if (treeType == "2") {

                $("#tree_taxa").hide();
                $("#tree_kegg").show();
                $("#tree_nz").hide();

                $("#cat_off").show();
                $("#cat_gibbs").hide();
                $("#cat_nitrogen").hide();

                $("#taxDiv").show();
                $("#taxTableH2").show();

                if (dataType == "1") {
                    $("#container-1").empty().show().append('Settings have been changed by the user!');
                    $("#container-2").empty().hide();
                    $("#text-1").empty().show();
                    $("#text-2").empty().hide();
                } else if (dataType == "2") {
                    $("#container-1").empty().hide();
                    $("#container-2").empty().show().append('Settings have been changed by the user!');
                    $("#text-1").empty().hide();
                    $("#text-2").empty().show();
                }
            }

            if (treeType == "3") {
                var nzAll = document.getElementById("selectall-nz").value;
                $("#tree_taxa").hide();
                $("#tree_kegg").hide();
                $("#tree_nz").show();

                if (dataType == "1") {
                    $("#container-1").empty().show().append('Settings have been changed by the user!');
                    $("#container-2").empty().hide();
                    $("#text-1").empty().show();
                    $("#text-2").empty().hide();

                    $("#taxDiv").show();
                    $("#taxTableH2").show();

                    if (nzAll == 5) {
                        $("#cat_off").hide();
                        $("#cat_gibbs").show();
                        $("#cat_nitrogen").hide();
                    } else if (nzAll == 6) {
                        $("#cat_off").hide();
                        $("#cat_gibbs").hide();
                        $("#cat_nitrogen").show();
                    } else {
                        $("#cat_off").show();
                        $("#cat_gibbs").hide();
                        $("#cat_nitrogen").hide();
                    }
                } else if (dataType == "2") {
                    $("#container-1").empty().hide();
                    $("#container-2").empty().show().append('Settings have been changed by the user!');
                    $("#text-1").empty().hide();
                    $("#text-2").empty().show();
                    $("#cat_off").show();
                    $("#cat_gibbs").hide();
                    $("#cat_nitrogen").hide();
                }
            }
            return 0;
        }

        function stopThis(RID) {
            clearInterval(refresh);
            $.ajax({
                url: '/myPhyloDB/stop/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: RID
                },
                success: function (data) {
                    $("#run").css("background-color", "red");
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var stage = obj['message'];
                    if (button1 == 1) {
                        $('#container-1').empty().append(stage);
                    } else if (button1 == 2) {
                        $('#container-2').empty().append(stage);
                    }
                }
            });
        }

        function updateStatus(RID) {
            var myDict = {};
            myDict['reqType'] = "status";
            myDict['RID'] = RID;
            myDict['funcName'] = "anovaStatus";
            var jsonDict = JSON.stringify(myDict);
            $.ajax({
                url: '/myPhyloDB/funcCall/',
                type: 'POST',
                data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}'),
                success: function (data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var resType = obj['resType'];
                    if (resType == "status") {
                        var stage = obj['stage'];
                        if (running) {
                            if (button1 == 1) {
                                $('#container-1').empty().append(stage);
                            } else if (button1 == 2) {
                                $('#container-2').empty().append(stage);
                            }
                        }
                    } else {
                        stopTimer(refresh);
                        running = false;
                        var xAxis = data['xAxis'];
                        var series = data['series'];
                        var yAxis = data['yAxis'];
                        var empty = data['empty'];
                        var error = data['error'];
                        if (error != "none") {
                            alert(error);
                            $("#run").css("background-color", "red");
                            $("#container-1").empty();
                            return
                        } else {
                            $("#run").css("background-color", "green");
                        }

                        var text = data['text'];

                        if (button3 != "1") {
                            var taxData = eval(data['taxData']);
                            var taxColumns = JSON.parse(data['taxColumns']);
                            var tableHeaders = '';
                            for (var i = 0; i < taxColumns.length; i++) {
                                tableHeaders += "<th>" + taxColumns[i] + "</th>";
                            }

                            $("#taxDiv").empty().append('<table id="taxTable" class="display" cellspacing="0" width="100%"><thead><tr>' + tableHeaders + '</tr></thead></table>');

                            var table = $('#taxTable').DataTable({
                                "dom": 'B<"toolbar">lfrtip',
                                "deferRender": true,
                                "data": taxData,
                                "scrollX": true,
                                "bPaginate": true,
                                "sPaginationType": 'full_numbers',
                                "buttons": ['copy', 'csv', 'excel', 'pdf', 'print']
                            });
                            $("div.toolbar").html('<br><br><br>');
                        }
                        if (document.getElementById("button1").value == 1) {
                            if (empty == 0) {
                                $("#container-1").empty().append('No significant tests!');
                            } else {
                                barchart(xAxis, yAxis, series);
                                if (button3 == 3) {
                                    if (nzAll == 5) {
                                        gibbs();
                                    }
                                    if (nzAll == 6) {
                                        ncycle();
                                    }
                                }
                            }
                            $('#text-1').val(text);

                        } else {
                            if (empty == 0) {
                            $("#container-2").empty().append('No significant regressions!');
                            } else {
                                linechart(xAxis, yAxis, series);
                            }
                            $('#text-2').val(text);
                        }
                        document.getElementById("TabButton").disabled = false;
                    }

                }
            });
        }

        function startTimer(RID) {
            refresh = setInterval(function(){
                updateStatus(RID);
            }, 1000);
            return refresh;
        }

        function stopTimer() {
            clearInterval(refresh);
        }

        function chooseDisplay() {
            if (button1 == 1) {
                $("#tree_metaQuant").show();
                $("#tree_metaCat").show();
                $("#container-2").hide();
                $("#container-1").show();
                $("#text-1").show();
                $("#text-2").hide();
            }
            else if (button1 == 2) {
                $("#tree_metaCat").show();
                $("#tree_metaQuant").show();
                $("#container-1").hide();
                $("#container-2").show();
                $("#text-1").hide();
                $("#text-2").show();
            }
        }

        function chooseData() {
            if (button3 == 1) {
                var taxaAll = document.getElementById("selectall-taxa").value;
                if (button1 == 1) {
                    if ( (nodesCat != "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-1").empty().append('Analysis is running...please be patient');
                        getCatGraphData();
                    } else if ( (nodesCat == "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s) and taxa level(s)!');
                        running = false;
                    } else if ( (nodesCat == "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s)!');
                        running = false;
                    } else if ( (nodesCat != "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your taxa level(s)!');
                        running = false;
                    }
                } else if (button1 == 2) {
                    if ( (nodesQuant != "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-2").empty().append('Analysis is running...please be patient');
                        getQuantGraphData();
                    } else if ( (nodesQuant == "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s) and taxa level(s)!');
                        running = false;
                    } else if ( (nodesQuant == "") && ( (nodesTaxa != "") || (taxaAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s)!');
                        running = false;
                    } else if ( (nodesQuant != "") && (nodesTaxa == "") && (taxaAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your taxa level(s)!');
                        running = false;
                    }
                }
            }

            if (button3 == 2) {
                var keggAll = document.getElementById("selectall-kegg").value;
                if (button1 == 1) {
                    if ( (nodesCat != "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-1").empty().append('Analysis is running...please be patient');
                        getCatGraphData();
                    } else if ( (nodesCat == "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesCat == "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s)!');
                        running = false;
                    } else if ( (nodesCat != "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                } else if (button1 == 2) {
                    if ( (nodesQuant != "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-2").empty().append('Analysis is running...please be patient');
                        getQuantGraphData();
                    } else if ( (nodesQuant == "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesQuant == "") && ( (nodesKEGG != "") || (keggAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s)!');
                        running = false;
                    } else if ( (nodesQuant != "") && (nodesKEGG == "") && (keggAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                }
            }

            if (button3 == 3) {
                var nzAll = document.getElementById("selectall-nz").value;
                if (button1 == 1) {
                    if ( (nodesCat != "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-1").empty().append('Analysis is running...please be patient');
                        getCatGraphData();
                    } else if ( (nodesCat == "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesCat == "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your categorical variable(s)!');
                        running = false;
                    } else if ( (nodesCat != "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-1").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                } else if (button1 == 2) {
                    if ( (nodesQuant != "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "yellow");
                        $("#container-2").empty().append('Analysis is running...please be patient');
                        getQuantGraphData();
                    } else if ( (nodesQuant == "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s) and KEGG level(s)!');
                        running = false;
                    } else if ( (nodesQuant == "") && ( (nodesNZ != "") || (nzAll != 0) ) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your quantitative variable(s)!');
                        running = false;
                    } else if ( (nodesQuant != "") && (nodesNZ == "") && (nzAll == 0) ) {
                        $("#run").css("background-color", "red");
                        $("#container-2").empty().append('Please choose your KEGG level(s)!');
                        running = false;
                    }
                }
            }

        }

        function checkDupes(list) {
            var bools = [];
            var firsts = [];
            for (var i=0; i<list.length; i++) {
                var sub = list[i].split(':');
                var found = firsts.indexOf(sub[0]);
                if (found==-1) {
                    firsts.push(sub[0]);
                    bools.push(false);
                } else {
                    bools[found] = true;
                }
            }
            return (bools.indexOf(false)==-1);
        }

        function makeGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            })
        }

        function getCatGraphData() {
            RID = makeGUID();
            startTimer(RID);
            var arrayValsCat = [];
            var arrayIDsCat = [];
            var arrayValsQuant = [];
            var arrayIDsQuant = [];
            var key = '';
            var value = '';
            var vals = '';
            var id = '';
            var ids = '';
            for (var i = 0; i < nodesQuant.length; i++) {
                if (nodesQuant[i].getLevel() == 5) {
                    if ((nodesQuant[i].data.table == 'mimark') || (nodesQuant[i].data.table == 'user')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
                else if (nodesQuant[i].getLevel() == 6) {
                    if ((nodesQuant[i].data.table == 'human_associated') || (nodesQuant[i].data.table == 'soil')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
            }
            for (var i = 0; i < nodesCat.length; i++) {
                if (nodesCat[i].getLevel() == 5) {
                    if ((nodesCat[i].data.table == 'mimark') || (nodesCat[i].data.table == 'user')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
                else if (nodesCat[i].getLevel() == 6) {
                    if ((nodesCat[i].data.table == 'human_associated') || (nodesCat[i].data.table == 'soil')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
            }

            if (!checkDupes(arrayValsCat)) {
                stopTimer(RID);
                $("#run").css("background-color", "lightgray");
                $("#container-1").empty().append('Analysis has been cancelled!');
                alert("Selected meta data only has one level.\nPlease select a different variable.");
            } else {
                var metaValsCat = '';
                if (nodesCat.length > 0) {
                    metaValsCat = "{" + arrayValsCat.join(",") + "}";
                }

                var metaIDsCat = '';
                if (nodesCat.length > 0) {
                    metaIDsCat = "{" + arrayIDsCat.join(",") + "}";
                }

                var metaValsQuant = '';
                if (nodesQuant.length > 0) {
                    metaValsQuant = "{" + arrayValsQuant.join(",") + "}";
                }

                var metaIDsQuant = '';
                if (nodesQuant.length > 0) {
                    metaIDsQuant = "{" + arrayIDsQuant.join(",") + "}";
                }

                var array2 = [];
                for (i = 0; i < nodesTaxa.length; i++) {
                    key = nodesTaxa[i].data.tooltip;
                    value = nodesTaxa[i].data.id;
                    if (nodesTaxa[i].getLevel() >= 2) {
                        var next = '"' + key + '" : "' + value + '"';
                        array2.push(next);
                    }
                }

                var taxa = "{" + array2.join(",") + "}";

                var array3 = [];
                for (i = 0; i < nodesKEGG.length; i++) {
                    key = nodesKEGG[i].data.kegg;
                    value = nodesKEGG[i].data.id;
                    if (nodesKEGG[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array3.push(next);
                    }
                }

                var kegg = "{" + array3.join(",") + "}";

                var array4 = [];
                for (i = 0; i < nodesNZ.length; i++) {
                    key = nodesNZ[i].data.kegg;
                    value = nodesNZ[i].data.id;
                    if (nodesNZ[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array4.push(next);
                    }
                }

                var nz = "{" + array4.join(",") + "}";

                var myDict = {};
                myDict['metaValsCat'] = metaValsCat;
                myDict['metaIDsCat'] = metaIDsCat;
                myDict['metaValsQuant'] = metaValsQuant;
                myDict['metaIDsQuant'] = metaIDsQuant;
                myDict['taxa'] = taxa;
                myDict['kegg'] = kegg;
                myDict['nz'] = nz;
                myDict['RID'] = RID;
                myDict['button3'] = button3;
                myDict['funcName'] = "getCatUnivData";
                myDict['reqType'] = "call";
                myDict['dataID'] = dataID;

                if ($("#remUnclass").is(':checked')) {
                    myDict['remUnclass'] = 'yes'
                } else {
                    myDict['remUnclass'] = 'no'
                }

                if ($("#remZeroes").is(':checked')) {
                    myDict['remZeroes'] = 'yes'
                } else {
                    myDict['remZeroes'] = 'no'
                }

                if ($("#filterData").is(':checked')) {
                    myDict['filterData'] = 'yes'
                } else {
                    myDict['filterData'] = 'no'
                }

                myDict['perZeroes'] = document.getElementById("perZeroes").value;
                myDict['filterPer'] = document.getElementById("filterPer").value;
                myDict['filterMeth'] = document.getElementById("filterMeth").value;

                myDict['DepVar'] = document.getElementById("DepVar").value;
                myDict['sig_only'] = document.getElementById("sig_box").checked;
                myDict['selectAll'] = document.getElementById("selectall-taxa").value;
                myDict['keggAll'] = document.getElementById("selectall-kegg").value;
                myDict['nzAll'] = document.getElementById("selectall-nz").value;
                myDict['transform'] = document.getElementById("transform").value;

                var jsonDict = JSON.stringify(myDict);
                $.ajax({
                    type: 'POST',
                    url: '/myPhyloDB/funcCall/',
                    data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}')
                });

            }
        }

        function getQuantGraphData() {
            var RID = makeGUID();
            startTimer(RID);
            var arrayValsCat = [];
            var arrayIDsCat = [];
            var arrayValsQuant = [];
            var arrayIDsQuant = [];
            var key = '';
            var value = '';
            var vals = '';
            var id = '';
            var ids = '';
            for (var i = 0; i < nodesQuant.length; i++) {
                if (nodesQuant[i].getLevel() == 5) {
                    if ((nodesQuant[i].data.table == 'mimark') || (nodesQuant[i].data.table == 'user')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
                else if (nodesQuant[i].getLevel() == 6) {
                    if ((nodesQuant[i].data.table == 'human_associated') || (nodesQuant[i].data.table == 'soil')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
            }
            for (var i = 0; i < nodesCat.length; i++) {
                if (nodesCat[i].getLevel() == 5) {
                    if ((nodesCat[i].data.table == 'mimark') || (nodesCat[i].data.table == 'user')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
                else if (nodesCat[i].getLevel() == 6) {
                    if ((nodesCat[i].data.table == 'human_associated') || (nodesCat[i].data.table == 'soil')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
            }

            if (!checkDupes(arrayValsCat)) {
                stopTimer(RID);
                $("#run").css("background-color", "lightgray");
                $("#container-1").empty().append('Analysis has been cancelled!');
                alert("Selected meta data only has one level.\nPlease select a different variable.");
            } else {
                var metaValsCat = '';
                if (nodesCat.length > 0) {
                    metaValsCat = "{" + arrayValsCat.join(",") + "}";
                }

                var metaIDsCat = '';
                if (nodesCat.length > 0) {
                    metaIDsCat = "{" + arrayIDsCat.join(",") + "}";
                }

                var metaValsQuant = '';
                if (nodesQuant.length > 0) {
                    metaValsQuant = "{" + arrayValsQuant.join(",") + "}";
                }

                var metaIDsQuant = '';
                if (nodesQuant.length > 0) {
                    metaIDsQuant = "{" + arrayIDsQuant.join(",") + "}";
                }

                var array2 = [];
                for (i = 0; i < nodesTaxa.length; i++) {
                    key = nodesTaxa[i].data.tooltip;
                    value = nodesTaxa[i].data.id;
                    if (nodesTaxa[i].getLevel() >= 2) {
                        var next = '"' + key + '" : "' + value + '"';
                        array2.push(next);
                    }
                }

                var taxa = "{" + array2.join(",") + "}";
                var array3 = [];
                for (i = 0; i < nodesKEGG.length; i++) {
                    key = nodesKEGG[i].data.kegg;
                    value = nodesKEGG[i].data.id;
                    if (nodesKEGG[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array3.push(next);
                    }
                }

                var kegg = "{" + array3.join(",") + "}";

                var array4 = [];
                for (i = 0; i < nodesNZ.length; i++) {
                    key = nodesNZ[i].data.kegg;
                    value = nodesNZ[i].data.id;
                    if (nodesNZ[i].getLevel() >= 1) {
                        var next = '"' + key + '" : "' + value + '"';
                        array4.push(next);
                    }
                }

                var nz = "{" + array4.join(",") + "}";

                var myDict = {};
                myDict['metaValsCat'] = metaValsCat;
                myDict['metaIDsCat'] = metaIDsCat;
                myDict['metaValsQuant'] = metaValsQuant;
                myDict['metaIDsQuant'] = metaIDsQuant;
                myDict['taxa'] = taxa;
                myDict['RID'] = RID;
                myDict['kegg'] = kegg;
                myDict['nz'] = nz;
                myDict['button3'] = button3;
                myDict['funcName'] = "getQuantUnivData";
                myDict['reqType'] = "call";
                myDict['dataID'] = dataID;

                if ($("#remUnclass").is(':checked')) {
                    myDict['remUnclass'] = 'yes'
                } else {
                    myDict['remUnclass'] = 'no'
                }

                if ($("#remZeroes").is(':checked')) {
                    myDict['remZeroes'] = 'yes'
                } else {
                    myDict['remZeroes'] = 'no'
                }

                if ($("#filterData").is(':checked')) {
                    myDict['filterData'] = 'yes'
                } else {
                    myDict['filterData'] = 'no'
                }

                myDict['perZeroes'] = document.getElementById("perZeroes").value;
                myDict['filterPer'] = document.getElementById("filterPer").value;
                myDict['filterMeth'] = document.getElementById("filterMeth").value;

                myDict['DepVar'] = document.getElementById("DepVar").value;
                myDict['sig_only'] = document.getElementById("sig_box").checked;
                myDict['selectAll'] = document.getElementById("selectall-taxa").value;
                myDict['keggAll'] = document.getElementById("selectall-kegg").value;
                myDict['nzAll'] = document.getElementById("selectall-nz").value;
                myDict['transform'] = document.getElementById("transform").value;

                var jsonDict = JSON.stringify(myDict);

                $.ajax({
                    url: '/myPhyloDB/funcCall/',
                    type: 'POST',
                    data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}')
                });
            }
        }

        function barchart(xAxis, yAxis, series) {
            var categories = series[0].data.length;
            var width = categories*100+600;

            catOptions = {
                chart: {
                    renderTo: 'container-1',
                    height: 400,
                    width: width,
                    spacingRight: 50,
                    type: 'column',
                    events: {
                        load: function () {
                            var chart = this,
                                    legend = chart.legend;
                            for (var i = 0, len=legend.allItems.length; i< len; i++) {
                                (function(i) {
                                    var item = legend.allItems[i].legendItem;
                                    var color = chart.series[i].color;
                                    item.on('mouseover', function (e) {
                                        $(this).qtip({
                                            content: {
                                                text: 'Index: ' + i + '<br>' + 'Color: ' + color
                                            },
                                            style: {
                                                classes: 'qtip-jtools'
                                            },
                                            show: {
                                                ready: true
                                            }
                                        });
                                    });
                                })(i);
                            }
                        }
                    }
                },
                title: { text: null },
                legend: {
                    itemStyle: {
                        fontSize: '10px',
                        font: '10pt Trebuchet MS, Verdana, sans-serif',
                        width: 300
                    },
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical',
                    x: -25,
                    y: 25,
                    labelFormatter: function () {
                        if (button3 == 3) {
                            return this.name[1] + '<br/>'
                        } else {
                            return this.name[0] + ': ' + this.name[1] + '<br/>'
                        }
                    }
                },
                xAxis: xAxis,
                yAxis: yAxis,
                series: series,
                tooltip: {
                    formatter: function () {
                        return this.series.name[0] + ':' + this.series.name[1] + '<br/>' +
                            'ID: ' + this.series.name[2] + '<br/>' +
                            'Value: ' + this.y + '<br/>' +
                            'Total: ' + this.point.stackTotal;
                    }
                },
                plotOptions: {
                    column: { stacking: "normal"},
                    series: { borderWidth: 0}
                },
                credits: { enabled: false }
            };
            if (unstackButton) {
                catOptions.plotOptions.column.stacking = null;
            }
            chart1 = new Highcharts.Chart(catOptions);
        }

        function linechart(xAxis, yAxis, series) {
            quantOptions = {
                chart: {
                    renderTo: 'container-2',
                    height: 400,
                    width: 850,
                    spacingRight: 50,
                    type: 'scatter',
                    zoomType: 'xy',
                    events: {
                        load: function () {
                            var chart = this,
                                    legend = chart.legend;
                            for (var i = 0, len=legend.allItems.length; i< len; i++) {
                                (function(i) {
                                    var item = legend.allItems[i].legendItem;
                                    var color = chart.series[i].color;
                                    var symbol = chart.series[i].symbol;
                                    var type = chart.series[i].type;
                                    item.on('mouseover', function (e) {
                                        if (type == 'scatter') {
                                            $(this).qtip({
                                                content: {
                                                    text: 'Index: ' + i + '<br>' + 'Color: ' + color + '<br>' + 'Symbol: ' + symbol
                                                },
                                                style: {
                                                    classes: 'qtip-jtools'
                                                },
                                                show: {
                                                    ready: true
                                                }
                                            });
                                        }
                                        if (type == 'line') {
                                            $(this).qtip({
                                                content: {
                                                    text: 'Index: ' + i + '<br>' + 'Color: ' + color
                                                },
                                                style: {
                                                    classes: 'qtip-jtools'
                                                },
                                                show: {
                                                    ready: true
                                                }
                                            });
                                        }
                                    });
                                })(i);
                            }
                        }
                    }
                },
                title: { text: null },
                legend: {
                    itemStyle: {
                        fontSize: '10px',
                        font: '10pt Trebuchet MS, Verdana, sans-serif',
                        width: 250
                    },
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical',
                    x: -25,
                    y: 25
                },
                xAxis: xAxis,
                yAxis: yAxis,
                series: series,
                tooltip: {
                    formatter: function () {
                        if (this.point.name == undefined) {
                            return this.series.name
                        } else {
                            return this.point.name + '<br/>' + '(' + this.x + ',' + this.y + ')'
                        }
                    }
                },
                credits: { enabled: false }
            };
            chart2 = new Highcharts.Chart(quantOptions);
        }

    </script>

{% endblock javascript %}

{% block my_content %}
    <br>
    <!-- tree tables -->
    <div>
        <table border="2" cellspacing="0" cellpadding="5" class="inlineTable">
            <tr style="height: 40px;">
                <th>Select Meta Data:<br>
                    <a href="#" id="clearMeta" style="font-size: 12px;">-Deselect all-</a>
                </th>
            </tr>
            <tr>
                <td style="padding-right: 10px; vertical-align: top">
                    <div id="tree_metaCat"></div>
                    <div id="tree_metaQuant"></div>
                </td>
            </tr>
        </table>

        {% include "html/ResponseTree.html" %}

        <table border="0" cellspacing="0" cellpadding="5"  class="inlineTable">
            {% include "html/AnalysisType.html" %}
            <tr><td bgcolor="white"></td></tr>
            {% include "html/DataSelection.html" %}
            <tr><td bgcolor="white"></td></tr>
            {% include "html/DataFiltering.html" %}
            <tr><td bgcolor="white"></td></tr>
            {% include "html/RunButton.html" %}
            <tr><td bgcolor="white"></td></tr>
            {% include "html/ExportButton.html" %}
        </table>
    </div>
    <br><br>

    <table width="950px" border="2" style="table-layout: fixed">
        <colgroup>
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
        </colgroup>
        <tr>
            <th colspan="20" style="padding-right: 10px;">GraphData</th>
        </tr>
        <tr>
            <td colspan="8" style="text-align: center"></td>
            {% include "html/UnstackButton.html" %}
            {% include "html/CatSubset.html" %}
        </tr>
        <tr>
            <td colspan="20" style="text-align: left">
                <div id="container-1" style="height: 425px; width: 935px; overflow-x: auto;">No Data has been selected!</div>
                <div id="container-2" style="height: 425px; width: 935px; overflow-x: auto; display: none">No Data has been selected!</div>
            </td>
        </tr>
        <tr id="highchartButtons">
            <td colspan="6" style="text-align: center">
                <button id="hide" title="Click to show/hide all series in the graph">Hide all series</button>
            </td>
            {% include "html/ChartTheme.html" %}
            <td colspan="6" style="text-align: center">
                <button id="button" title="Click to change an individual series color or symbol">Change series</button>
            </td>
        </tr>
    </table>
    {% include "html/ResultBox.html" %}
    <br><br>

    <h2 id="taxTableH2">Mapped Taxa:</h2>
    <div id="taxDiv" style="width: 950px; overflow-x: auto;"></div>
    <br><br>
    <br><br>
{% endblock my_content%}
