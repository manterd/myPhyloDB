{% extends 'site_base.html' %}
{% load static %}

{% block pagetitle %}
    <title>PCoA</title>
{% endblock pagetitle %}

{% block user %}
    {% if user.is_authenticated %}
        <p>You are logged in as:<br>&nbsp;{{ user.username }}</p>
    {% endif %}
{% endblock user %}

{% block javascript %}
    <style>
        .inlineTable {
            display: inline-block;
            vertical-align: top;
        }
    </style>

    <script type="text/javascript">
        var dataType = 1, treeType = 1;
        var nodesCat = "", nodesQuant = "";
        var chart1 = {}, catOptions = {};
        var unstackButton = false;
        var running = false, refresh = 0, RID = 0;
        var HCDefaults = $.extend(true, {}, Highcharts.getOptions(), {});

        $(function () {
            $(window).load(function() {
                checkButtons();
            });
            $(window).bind('unload', function(){
                $.ajax({
                    url: '/myPhyloDB/removeFiles/',
                    async: false,
                    dataType: 'json',
                    data: {
                        all: RID,
                        func: 'pcoa'
                    }
                });
            });
            $(".input tr:not(.accordion)").hide();
            $(".input tr.accordion").click(function () {
                var $arrow = $(this).find(".arrow:first");
                $arrow.text($arrow.text() == '►' ? '▼' : '►');
                $(this).nextUntil(".accordion").fadeToggle('fast');
            });
            $(".input tr.accordion:eq(0)").trigger('click');
            $(".input tr.accordion:eq(4)").trigger('click');
        });

        {% include "js/commonFunctions.js" %}
        function checkButtons() {
            treeType = document.getElementById("selectTree").value;
            $("#run").css("background-color", "lightgray");

            if (treeType == 1) {
                $("#container-0").empty().show().append('Settings have been changed by the user!');
                $("#container-1").empty().hide();
                $("#container-2").hide();
                $("#row_taxa").show();
                $("#row_kegg").hide();
                $("#row_nz").hide();
            }
            if (treeType == 2) {
                $("#container-0").empty().show().append('Settings have been changed by the user!');
                $("#container-1").empty().hide();
                $("#container-2").hide();
                $("#row_taxa").hide();
                $("#row_kegg").show();
                $("#row_nz").hide();
            }
            if (treeType == 3) {
                $("#container-0").empty().show().append('Settings have been changed by the user!');
                $("#container-1").empty().hide();
                $("#container-2").hide();
                $("#row_taxa").hide();
                $("#row_kegg").hide();
                $("#row_nz").show();
            }
        }
        function colorBox() {
            $("#colorVal").empty().prepend('<option selected="selected" value="None">None</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#colorVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#colorVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
            if (titleArray.length > 1) {
                $("#colorVal").append('<option value=interaction>interaction</option>');
            }
        }
        function DepVar() {
            var DepVar = document.getElementById("DepVar").value;
            if (DepVar == 1) {
                $('#transform').empty()
                    .append('<option value="0">None</option>')
                    .append('<option value="3">Sqrt</option>')
                    .append('<option value="4">Logit</option>')
                    .append('<option value="5">Arcsin</option>');
            } else {
                $('#transform').empty()
                    .append('<option value="0" selected>None</option>')
                    .append('<option value="1">Ln</option>')
                    .append('<option value="2">Log10</option>')
                    .append('<option value="3">Sqrt</option>');
            }
            checkButtons();
        }
        function ellipseBox() {
            $("#ellipseVal").empty().prepend('<option selected="selected" value="None">None</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#ellipseVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#ellipseVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
            if (titleArray.length > 1) {
                $("#ellipseVal").append('<option value=interaction>interaction</option>');
            }
        }
        function gridBox() {
            $("#gridVal_X").empty().prepend('<option selected="selected" value="None">None</option>');
            $("#gridVal_Y").empty().prepend('<option selected="selected" value="None">None</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#gridVal_X").append('<option value='+title+'>'+title+'</option>');
                            $("#gridVal_Y").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#gridVal_X").append('<option value='+title+'>'+title+'</option>');
                            $("#gridVal_Y").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
        }
        function chooseDisplay() {
            var graphType = document.getElementById("graphDisplay").value;
            if ( $("#run").css("background-color") == "rgb(0, 128, 0)" ) {
                if (graphType == 1) {
                    $("#container-0").hide();
                    $("#container-1").show();
                    $("#container-2").hide();
                    $("#highchartButtons").show();
                }
                if (graphType == 2) {
                    $("#container-0").hide();
                    $("#container-1").hide();
                    $("#container-2").show();
                    $("#highchartButtons").hide();

                    {% static "" as baseUrl %}
                    $("#my_image").removeAttr("src").attr("src", "{{ baseUrl }}/temp/pcoa/Rplots/" + RID +".pcoa.pdf");
                }
            } else {
                $("#container-0").show();
                $("#container-1").hide();
                $("#container-2").hide();
            }
        }
        function chooseData() {
            if (document.getElementById("alphaVal").value < 0 || document.getElementById("alphaVal").value > 10){
                alert("Alpha must be between 0 and 10");
                running = false;
                return;
            }

            if (nodesCat == "") {
                $("#container-0").empty().append('Please choose a categorical variable(s)!');
                $("#text-1").val('No data selected');
                $("#text-raw").val('No data selected');
                $("#run").css("background-color", "red");
                running = false;
            }
            if (nodesCat != "") {
                $("#run").css("background-color", "yellow");
                $("#container-0").empty().append('Analysis is running...please be patient');
                getGraphData();
            }
        }
        function selectDistance() {
            checkButtons();
            if (document.getElementById("distance").value == 15) {
                $("#alphaLevel").show();
            } else {
                $("#alphaLevel").hide();
            }
        }
        function getGraphData() {
            RID = makeGUID();
            startTimer(RID);
            var arrayValsCat = [];
            var arrayIDsCat = [];
            var arrayValsQuant = [];
            var arrayIDsQuant = [];
            var key = '';
            var value = '';
            var vals = '';
            var id = '';
            var ids = '';

            for (var i = 0; i < nodesQuant.length; i++) {
                if (nodesQuant[i].getLevel() == 5) {
                    if ((nodesQuant[i].data.table == 'mimark') || (nodesQuant[i].data.table == 'user')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
                else if (nodesQuant[i].getLevel() == 6) {
                    if ((nodesQuant[i].data.table == 'human_associated') || (nodesQuant[i].data.table == 'soil') || (nodesQuant[i].data.table == 'air') || (nodesQuant[i].data.table == 'microbial') || (nodesQuant[i].data.table == 'water')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
            }

            for (var i = 0; i < nodesCat.length; i++) {
                if (nodesCat[i].getLevel() == 5) {
                    if ((nodesCat[i].data.table == 'mimark') || (nodesCat[i].data.table == 'user')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
                else if (nodesCat[i].getLevel() == 6) {
                    if ((nodesCat[i].data.table == 'human_associated') || (nodesCat[i].data.table == 'soil') || (nodesCat[i].data.table == 'air') || (nodesCat[i].data.table == 'microbial') || (nodesCat[i].data.table == 'water')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
            }

            var metaValsCat = '';
            if (nodesCat.length > 0) {
                metaValsCat = "{" + arrayValsCat.join(",") + "}";
            }

            var metaIDsCat = '';
            if (nodesCat.length > 0) {
                metaIDsCat = "{" + arrayIDsCat.join(",") + "}";
            }

            var metaValsQuant = '';
            if (nodesQuant.length > 0) {
                metaValsQuant = "{" + arrayValsQuant.join(",") + "}";
            }

            var metaIDsQuant = '';
            if (nodesQuant.length > 0) {
                metaIDsQuant = "{" + arrayIDsQuant.join(",") + "}";
            }

            var metaVals = '';
            if ((nodesCat.length > 0) && (nodesQuant.length > 0)) {
                metaVals = "{" + arrayValsCat.join(",") + "," + arrayValsQuant.join(",") + "}";
            } else if ((nodesCat.length == 0) && (nodesQuant.length > 0)) {
                metaVals = "{" + arrayValsQuant.join(",") + "}";
            } else if ((nodesCat.length > 0) && (nodesQuant.length == 0)) {
                metaVals = "{" + arrayValsCat.join(",") + "}";
            }

            var metaIDs = '';
            if ((nodesCat.length > 0) && (nodesQuant.length > 0)) {
                metaIDs = "{" + arrayIDsCat.join(",") + "," + arrayIDsQuant.join(",") + "}";
            } else if ((nodesCat.length == 0) && (nodesQuant.length > 0)) {
                metaIDs = "{" + arrayIDsQuant.join(",") + "}";
            }  else if ((nodesCat.length > 0) && (nodesQuant.length == 0)) {
                metaIDs = "{" + arrayIDsCat.join(",") + "}";
            }

            var myDict = {};
            myDict['metaVals'] = metaVals;
            myDict['metaIDs'] = metaIDs;
            myDict['metaValsCat'] = metaValsCat;
            myDict['metaIDsCat'] = metaIDsCat;
            myDict['metaValsQuant'] = metaValsQuant;
            myDict['metaIDsQuant'] = metaIDsQuant;
            myDict['treeType'] = treeType;
            myDict['RID'] = RID;
            myDict['funcName'] = "getPCoA";
            myDict['reqType'] = "call";
            myDict['dataID'] = dataID;
            myDict['selectAll'] = document.getElementById("selectall-taxa").value;
            myDict['keggAll'] = document.getElementById("selectall-kegg").value;
            myDict['nzAll'] = document.getElementById("selectall-nz").value;
            myDict['DepVar'] = document.getElementById("DepVar").value;
            myDict['contribVal2'] = document.getElementById("contribVal2").value;
            myDict['Method'] = document.getElementById("Method").value;
            myDict['PC1'] = document.getElementById("PC1").value;
            myDict['PC2'] = document.getElementById("PC2").value;
            myDict['test'] = document.getElementById("test").value;
            myDict['distance'] = document.getElementById("distance").value;
            myDict['alpha'] = document.getElementById("alphaVal").value;
            myDict['perms'] = document.getElementById("perms").value;
            myDict['colorVal'] = document.getElementById("colorVal").value;
            myDict['gridVal_X'] = document.getElementById("gridVal_X").value;
            myDict['gridVal_Y'] = document.getElementById("gridVal_Y").value;
            myDict['palette'] = document.getElementById("palette").value;
            myDict['shapeVal'] = document.getElementById("shapeVal").value;
            myDict['ellipseVal'] = document.getElementById("ellipseVal").value;
            myDict['CI'] = document.getElementById("CI").value;
            myDict['surfVal'] = document.getElementById("surfVal").value;
            myDict['transform'] = document.getElementById("transform").value;
            myDict['perZeroes'] = document.getElementById("perZeroes").value;
            myDict['filterPer'] = document.getElementById("filterPer").value;
            myDict['filterMeth'] = document.getElementById("filterMeth").value;
            myDict['csrfmiddlewaretoken'] = '{{ csrf_token }}';

            if ($("#contrib2").is(':checked')) {
                myDict['addContrib2'] = 'yes'
            } else {
                myDict['addContrib2'] = 'no'
            }

            if ($("#remUnclass").is(':checked')) {
                myDict['remUnclass'] = 'yes'
            } else {
                myDict['remUnclass'] = 'no'
            }

            if ($("#remZeroes").is(':checked')) {
                myDict['remZeroes'] = 'yes'
            } else {
                myDict['remZeroes'] = 'no'
            }

            if ($("#filterData").is(':checked')) {
                myDict['filterData'] = 'yes'
            } else {
                myDict['filterData'] = 'no'
            }

            var jsonDict = JSON.stringify(myDict);

            $.ajax({
                url: '/myPhyloDB/funcCall/',
                type: 'POST',
                data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}'),
                success: function (data) {
                    var error = data['error'];
                    if (error != "none") {
                        alert(error);
                        $("#run").css("background-color", "red");
                    }
                }
            });
        }
        function runAnalysis() {
            if(running == true) {
                alert("myPhyloDB is currently running your previous analysis request!");
                return false;
            }
            $("#my_image").attr("src", "#");
            $("#Export").val('Export Data').css('background-color', 'lightgray');

            $("#container-0").empty().show();
            $("#container-1").hide();
            $("#container-2").hide();
            $("#text-1").val('');
            $("#dist_table").empty();
            $("#res_table").empty();
            running = true;
            chooseData();
        }
        function scatter(xAxis, yAxis, series) {
            catOptions = {
                chart: {
                    renderTo: 'container-1',
                    height: 400,
                    width: 850,
                    spacingRight: 50,
                    type: 'scatter',
                    zoomType: 'xy',
                    events: {
                        load: function () {
                            var chart = this,
                                    legend = chart.legend;
                            for (var i = 0, len=legend.allItems.length; i< len; i++) {
                                (function(i) {
                                    var item = legend.allItems[i].legendItem;
                                    var color = chart.series[i].color;
                                    var symbol = chart.series[i].symbol;
                                    item.on('mouseover', function (e) {
                                        $(this).qtip({
                                            content: {
                                                text: 'Index: ' + i + '<br>' + 'Color: ' + color + '<br>' + 'Symbol: ' + symbol
                                            },
                                            style: {
                                                classes: 'qtip-jtools'
                                            },
                                            show: {
                                                ready: true
                                            }
                                        });
                                    });
                                })(i);
                            }
                        }
                    }
                },
                title: { text: null },
                legend: {
                    itemStyle: {
                        fontSize: '10px',
                        font: '10pt Trebuchet MS, Verdana, sans-serif',
                        width: 250
                    },
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical',
                    x: -25,
                    y: 25
                },
                xAxis: xAxis,
                yAxis: yAxis,
                series: series,
                tooltip: {
                    formatter: function () {
                        return this.point.name + '<br/>' + '(' + this.x + ',' + this.y + ')'
                    }
                },
                plotOptions: {
                    series: {
                        marker: {
                            radius: 6
                        }
                    }
                },
                credits: { enabled: false }
            };
            chart1 = new Highcharts.Chart(catOptions);
        }
        function selectTree() {
            checkButtons();
            if (treeType == 1) {
                $('#row_taxa').show();
                $('#row_kegg').hide();
                $('#row_nz').hide();
                $('#text-1').val('');
            } else if (treeType == 2) {
                $('#row_taxa').hide();
                $('#row_kegg').show();
                $('#row_nz').hide();
                $('#text-1').val('');
            } else if (treeType == 3) {
                $('#row_taxa').hide();
                $('#row_kegg').hide();
                $('#row_nz').show();
                $('#text-1').val('');
            }
        }
        function shapeBox() {
            $("#shapeVal").empty()
                    .prepend('<option selected="selected" value="None">None</option>')
                    .append('<option value="k-means">k-means</option>');

            var titleArray = [];
            $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#shapeVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            titleArray.push(title);
                            $("#shapeVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
            if (titleArray.length > 1) {
                $("#shapeVal").append('<option value=interaction>interaction</option>');
            }
        }
        function stopAnalysis() {
            running = false;
            clearInterval(refresh);
            $.ajax({
                url: '/myPhyloDB/stop/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: RID
                },
                success: function (data) {
                    $("#run").css("background-color", "red");
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var stage = obj['message'];
                    $('#container-1').hide();
                    $('#container-2').hide();
                    $('#container-0').empty().show().append(stage);
                }
            });
        }
        function surfBox() {
            $("#surfVal").empty().prepend('<option selected="selected" value="None">None</option>');

            $("#tree_metaQuant").dynatree("getRoot").visit(function (node) {
                if (node.getLevel() == 3) {
                    if ((node.data.pType == 'mimark') || (node.data.pType == 'user')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            $("#surfVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
                if (node.getLevel() == 4) {
                    if ((node.data.pType == 'human_associated') || (node.data.pType == 'soil') || (node.data.pType == 'air') || (node.data.pType == 'microbial') || (node.data.pType == 'water')) {
                        if (node.bSelected || node.hasSubSel) {
                            var title = node.data.title;
                            $("#surfVal").append('<option value='+title+'>'+title+'</option>');
                        }
                    }
                }
            });
        }
        function updateStatus() {
            var myDict = {};
            myDict['funcName'] = "getPCoA";
            myDict['reqType'] = "status";
            myDict['RID'] = RID;
            var jsonDict = JSON.stringify(myDict);
            $.ajax({
                url: '/myPhyloDB/funcCall/',
                type: 'POST',
                data: jsonDict + "&csrfmiddlewaretoken=" + encodeURI('{{ csrf_token }}'),
                success: function (data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var resType = obj['resType'];
                    if (resType == "status") {
                        var stage = obj['stage'];
                        if (running) {
                            $('#container-0').empty().append(stage);
                        }
                    } else {
                        running = false;
                        clearInterval(refresh);
                        var xAxis = obj['xAxis'];
                        var series = obj['series'];
                        var yAxis = obj['yAxis'];
                        var error = data['error'];
                        if (error != "none") {
                            alert(error);
                            $("#run").css("background-color", "red");
                        } else {
                            $("#run").css("background-color", "green");
                        }

                        var text = obj['text'];
                        $('#text-1').val(text);

                        var res_table = obj['res_table'];
                        $('#res_table').empty().append(res_table).find('.table').DataTable({
                            dom: 'B<"toolbar">lfrtip',
                            deferRender: true,
                            scrollX: true,
                            bSort: true,
                            bPaginate: true,
                            sPaginationType: 'full_numbers',
                            buttons: [ 'copy', 'csv', 'excel', 'pdf', 'print' ]
                        }).draw();

                        var dist_table = obj['dist_table'];
                        $('#dist_table').empty().append(dist_table).find('.table').DataTable({
                            dom: 'B<"toolbar">lfrtip',
                            deferRender: true,
                            scrollX: true,
                            bSort: true,
                            bPaginate: true,
                            sPaginationType: 'full_numbers',
                            buttons: [ 'copy', 'csv', 'excel', 'pdf', 'print' ]
                        }).draw();

                        $("div.toolbar").html('<br><br><br>');

                        scatter(xAxis, yAxis, series);
                        chooseDisplay();

                    }

                }
            });
        }
    </script>
{% endblock javascript %}

{% block my_content %}
    <br>
    <!-- tree tables -->
    <div>
    <table border="2" cellspacing="0" cellpadding="5" class="inlineTable">
        <tr>
            <th>Select Meta Data:<br>
                <a href="#" id="clearMeta" style="font-size: 12px;" onClick="clearMeta()">-Deselect all-</a></th>
        </tr>
        <tr>
            <td style="padding-right: 10px; vertical-align: top">
                {% include "html/DynaTree-MetaCat.html" %}
                {% include "html/DynaTree-MetaQuant.html" %}
            </td>
        </tr>
    </table>

    <table border="0" cellspacing="0" cellpadding="5" class="inlineTable input">
        <tr class="accordion">
            <td bgcolor="white" width="5px"></td>
            <td colspan="2" bgcolor="lightgray" style="outline: thin solid"><em><strong><span class="arrow">►</span> Data Selection:</strong></em></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white">
                <select id="selectTree" onChange="selectTree()">
                    <option value="1" selected="selected">Taxonomy</option>
                    <option value="2" >KEGG orthology</option>
                    <option value="3" >KEGG enzyme</option>
                </select>
                &nbsp; <-- Sequence mapping
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td id="row_taxa" bgcolor="white">
                <select id="selectall-taxa" onChange="selectTree()">
                    <option value="2">Phyla</option>
                    <option value="3">Classes</option>
                    <option value="4">Orders</option>
                    <option value="5">Families</option>
                    <option value="6">Genera</option>
                    <option value="7">Species</option>
                    <option value="9" selected="selected">OTU_99</option>
                    <option value="8">PGPRs</option>
                </select>
                &nbsp; <-- Taxa level
            </td>
            <td  id="row_kegg" bgcolor="white" style="display:none">
                <select id="selectall-kegg" onChange="checkButtons()">
                    <option value="1" selected="selected">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                </select>
                &nbsp; <-- KEGG pathway level
            </td>
            <td id="row_nz" bgcolor="white" style="display:none">
                <select id="selectall-nz" onChange="checkButtons()">
                    <option value="1" selected="selected">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                    <option value="4">Level 4</option>
                    <option value="5">GIBBs</option>
                    <option value="6">N cycle</option>
                </select>
                &nbsp; <-- KEGG enzyme level
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white">
                <select id="DepVar" onChange="DepVar()">
                    <option value="0" selected="selected">Abundance</option>
                    <option value="1">Relative Abundance</option>
                    <option value="4">Total Abundance</option>
                    <option value="2">OTU Richness</option>
                    <option value="3">OTU Diversity</option>
                </select>
                &nbsp; <-- Dependent variable <span title="Abundance = number of sequence reads<br>Relative Abundance = proportion of total community<br>Total Abundance = 16S rRNA copies per mg soil<br>OTU Richness = number of OTUs<br>OTU Diversity = Shannon's Diversity Index"><font class="info" color="red">[info]</font></span>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white">
                <select id="transform" onChange="checkButtons()">
                    <option value="0" selected="selected">None</option>
                    <option value="1">Ln</option>
                    <option value="2">Log10</option>
                    <option value="3">Sqrt</option>
                    <!--<option value="4">Logit</option>
                    <option value="5">Arcsin</option>-->
                </select>
                &nbsp; <-- Raw data transformation <span title="Use caution as negative values may result!<br>If your analysis fails, and you feel you must transform your data, consider switching to Euclidean distances."><font color="red">[warning]</font></span>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr><td colspan="3" bgcolor="white"></td></tr>
        {% include "html/Data-Filtering.html" %}

        <tr><td colspan="3" bgcolor="white"></td></tr>
        <tr class="accordion">
            <td bgcolor="white"></td>
            <td colspan="2" bgcolor="lightgray" style="outline: thin solid"><em><strong><span class="arrow">►</span> Ordination Settings:</strong></em></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white">
                <select id="Method" onChange="checkButtons()">
                    <option value="capscale" selected="selected">Constrained Analysis of Principal Coordinates (CAP)</option>
                    <option value="metaMDS">Nonmetric Multidimensional Scaling (NMDS)</option>
                    <option value="wcmdscale">Weighted Classical (Metric) Multidimensional Scaling</option>
                </select>
                &nbsp; <-- Ordination Method
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white">
                <select id="distance" onChange="selectDistance()">
                    <option value="1">Manhattan</option>
                    <option value="2">Euclidean</option>
                    <option value="3">Canberra</option>
                    <option value="4" selected="selected">Bray-Curtis</option>
                    <option value="5">Kulczynski</option>
                    <option value="6">Jaccard</option>
                    <option value="7">Gower</option>
                    <option value="8">altGower</option>
                    <option value="9">Morisita</option>
                    <option value="10">Horn</option>
                    <option value="11">Mountford</option>
                    <option value="12">Binomial</option>
                    <option value="13">Chao</option>
                    <option value="14">Cao</option>
                    <option value="15">wOdum</option>
                </select>
                &nbsp; <-- Distance score<span id="alphaLevel" style="display: none">; use alpha (&#945) level <input type="text" id="alphaVal" value="1" style="width:40px; background-color: white" onChange="checkButtons()"/></span>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white">
                <select id="PC1" onChange="checkButtons()">
                    <option value="1" selected="selected">PC1</option>
                    <option value="2">PC2</option>
                    <option value="3">PC3</option>
                    <option value="4">PC4</option>
                    <option value="5">PC5</option>
                    <option value="6">PC6</option>
                </select>
                &nbsp; <-- 1st PCoA axis (x-axis)
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white" id="PC2-text">
                <select id="PC2" onChange="checkButtons()">
                    <option value="1">PC1</option>
                    <option value="2" selected="selected">PC2</option>
                    <option value="3">PC3</option>
                    <option value="4">PC4</option>
                    <option value="5">PC5</option>
                    <option value="6">PC6</option>
                </select>
                &nbsp; <-- 2nd PCoA axis (y-axis)
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white" width="5px"></td>
            <td bgcolor="white" id="test-text">
                <select id="test" onChange="checkButtons()">
                    <option value=1 selected="selected">perMANOVA</option>
                    <option value=2>betaDisper</option>
                </select>
                &nbsp; <-- Run test with <input type="text" id="perms" value="1000" style="width:40px; background-color: white"/> permutations
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr><td colspan="3" bgcolor="white"></td></tr>
        <tr class="accordion">
            <td bgcolor="white"></td>
            <td colspan="2" bgcolor="lightgray" style="outline: thin solid"><strong><em><span class="arrow">►</span> Optimize R plot:</em></strong></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <input type="checkbox" title="Click to turn on/off" id="contrib2" onClick="checkButtons()"/>
                    <input type="text" title="Enter the p-value cutoff for displaying quantitative variable(s)" id="contribVal2" value="0.05" style="background-color: white; width: 50px" onChange="checkButtons()"/>
                    &nbsp; <-- p-value cutoff for displaying quantitative variable vectors
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="palette" onChange="checkButtons()">
                        <option value="Set1">Set1</option>
                        <option value="Set2">Set2</option>
                        <option value="Set3">Set3</option>
                        <option value="Paired">Paired</option>
                        <option value="Dark2">Dark2</option>
                        <option value="Accent">Accent</option>
                    </select>
                    &nbsp; <-- Color palette for symbol colors
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="gridVal_X" onChange="checkButtons()">
                        <option value="None">None</option>
                    </select>
                    &nbsp; <-- Grouping variable for graph panels (horizontal)
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="gridVal_Y" onChange="checkButtons()">
                        <option value="None">None</option>
                    </select>
                    &nbsp; <-- Grouping variable for graph panels (vertical)
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="colorVal" onChange="checkButtons()">
                        <option value="None">None</option>
                    </select>
                    &nbsp; <-- Grouping variable for symbol colors
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="shapeVal" onChange="checkButtons()">
                        <option value="None">None</option>
                    </select>
                    &nbsp; <-- Grouping variable for symbol shapes
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="ellipseVal" onChange="checkButtons()">
                        <option value="None">None</option>
                    </select>
                    &nbsp; <-- Grouping variable for ordiellipse
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr id="CI-row">
            <td bgcolor="white"></td>
            <td bgcolor="white" style="padding-left: 30px;">
                <input type="text" title="Confidence interval must be between 0 and 1" id="CI" value="0.95" style="background-color: white; width: 50px" onChange="checkButtons()"/>
                &nbsp; <-- Enter the confidence interval to be displayed by the ellipse
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr>
            <td bgcolor="white"></td>
            <td bgcolor="white">
                <div style="background-color: white">
                    <select id="surfVal" onChange="checkButtons()">
                        <option value="None">None</option>
                    </select>
                    &nbsp; <-- Quantitative variable for ordisurf
                </div>
            </td>
            <td bgcolor="white"></td>
        </tr>

        <tr><td colspan="3" bgcolor="white"></td></tr>
        {% include "html/Data-RunButton.html" %}

        <tr><td colspan="3" bgcolor="white"></td></tr>
        {% include "html/Data-Export.html" %}
    </table>
    </div>
    <br>

    <div id="stage"></div>
    <br><br>

    <table width="950px" border="2" style="table-layout: fixed">
        <colgroup>
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
            <col width="5%"><col width="5%">
        </colgroup>
        <tr>
            <th colspan="20" style="padding-right: 10px;">GraphData</th>
        </tr>

        <tr>
            <td colspan="8" style="text-align: center"></td>
            <td colspan="4" style="text-align: center"></td>
            <td colspan="8" style="text-align: center">
                Display graph:
                <select id="graphDisplay" onChange="chooseDisplay()">
                    <option value="1">Highcharts</option>
                    <option value="2">R plot</option>
                </select>
            </td>
        </tr>

        <tr>
            <td colspan="20" style="text-align: left">
                <div id="container-0" style="height: 425px; width: 950px;">No Data has been selected!</div>
                <div id="container-1" style="height: 425px; width: 935px; overflow-x: auto; display:none"></div>
                <div id="container-2" style="height: 650px; width: 935px; display:none"><iframe id="my_image" src="#" height="100%" width="100%"></iframe></div>
            </td>
        </tr>

        <tr id="highchartButtons">
            {% include "html/HighChart-HideButton.html" %}
            {% include "html/HighChart-ThemeButton.html" %}
            {% include "html/HighChart-ChangeButton.html" %}
        </tr>
    </table>

    <div id="txt-1">
        <h2>Test Results:</h2>
        <textarea style="width: 950px;" wrap="off" id="text-1" rows="20">No data selected</textarea>
        <br>
    </div>
    <br>

    <h2>Principal Coordinates:</h2>
    <div id="res_table" style="width: 950px; overflow-x: auto;"></div>
    <br>

    <h2>Distance Scores:</h2>
    <div id="dist_table" style="width: 950px; overflow-x: auto;"></div>
    <br><br><br>
    <br><br><br>
{% endblock my_content%}
