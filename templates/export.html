{% extends 'base.html' %}
{% load static %}

{% block pagetitle %}
    <title>Export</title>
{% endblock pagetitle%}

{% block user %}
    {% if user.is_authenticated %}
        <p>User logged in as:<br>&nbsp;{{ user.username }}</p>
    {% else %}
        <p>User logged in as:<br>&nbsp;guest</p>
    {% endif %}
{% endblock user %}

{% block menu_item %}
    <p><input id="run" type="submit" value="Run Analysis!"/></p>
{% endblock menu_item %}

{% block javascript %}
    <style>
        .inlineTable {
            display: inline-block;
            vertical-align: top;
        }
    </style>

    <script type="text/javascript">
        var NormMeth = 1, selTheme = 0, i = 0;
        var nodesCat = "", nodesQuant = "", nodesTaxa = "", selectAll = 0;
        var refresh = 0;

        $(function () {
            $("#tree_metaCat").dynatree({
                checkbox: true,
                rootVisible: false,
                selectMode: 3,
                initAjax: {
                    url: '/getSampleCatTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onLazyRead: function (node) {
                    node.appendAjax({
                        url: '/getSampleCatTreeChildren/',
                        data: {pType: node.data.tooltip, field: node.data.title},
                        success: function (node) {
                            if (node.childList == undefined) {
                                alert('No samples are available for this variable!');
                            }
                        }
                    });
                },
                onSelect: function (flag, node) {
                    if (flag && node.childList == undefined) {
                        node.reloadChildren(function () {
                            node.select(false);
                            node.select(true);
                        });
                    }
                    nodesCat = node.tree.getSelectedNodes();
                    $("#run").css("background-color", "lightgray");
                }
            });

            $("#tree_metaQuant").dynatree({
                checkbox: true,
                selectMode: 3,
                initAjax: {
                    url: '/getSampleQuantTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onLazyRead: function (node) {
                    node.appendAjax({
                        url: '/getSampleQuantTreeChildren/',
                        data: {pType: node.data.tooltip, field: node.data.title},
                        success: function (node) {
                            if (node.childList == undefined) {
                                alert('No samples are available for this variable!');
                            }
                        }
                    });
                },
                onSelect: function (flag, node) {
                    if (flag && node.childList == undefined) {
                        node.reloadChildren(function () {
                            node.select(false);
                            node.select(true);
                        });
                    }
                    nodesQuant = node.tree.getSelectedNodes();
                    $("#run").css("background-color", "lightgray");
                }
            });

            $("#tree_taxa").dynatree({
                checkbox: true,
                selectMode: 2,
                initAjax: {
                    url: '/getTaxaTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onLazyRead: function (node) {
                    node.appendAjax({
                        url: '/getTaxaTreeChildren/',
                        data: {
                            tooltip: node.data.tooltip,
                            id: node.data.id
                        }
                    });
                },
                onSelect: function (flag, node) {
                    if (flag && node.childList == undefined) {
                        node.reloadChildren(function () {
                            node.select(false);
                            node.select(true);
                        });
                    }
                    nodesTaxa = node.tree.getSelectedNodes();
                    $("#run").css("background-color", "lightgray");
                    searchData();
                },
                onClick: function () {
                    selectAll = 0;
                    $("#selectall").val(0);
                }
            });

            $("#run").show().click(function () {
                chooseData();
            });


            $("#NormMeth").change(function () {
                NormMeth = $(this).val();
                chooseDisplay();
                $("#run").css("background-color", "lightgray");
            });

            $("#NormVal").change(function () {
                chooseDisplay();
                $("#run").css("background-color", "lightgray");
            });

            $("#Iters").change(function () {
                chooseDisplay();
                $("#run").css("background-color", "lightgray");
            });

            $("#MinVal").change(function () {
                chooseDisplay();
                $("#run").css("background-color", "lightgray");
            });


            $("#clearMeta").click(function () {
                $("#tree_metaCat").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $("#tree_metaQuant").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                $("#run").css("background-color", "lightgray");
            });

            $("#clearTaxa").click(function () {
                $("#selectall").val(0);
                $("#tree_taxa").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
                selectAll = 0;
                $("#run").css("background-color", "lightgray");
            });

            $("#selectall").change(function () {
                selectAll = $(this).val();
                $("#run").css("background-color", "lightgray");
                $("#tree_taxa").dynatree("getRoot").visit(function (node) {
                    node.select(false);
                });
            });
        });

        function updateStatus(RID) {
            $.ajax({
                url: '/statusExport/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: RID
                },
                success: function (data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    var stage = obj['stage'];
                    $('#container-1').empty().append(stage);
                }
            });
        }

        function startTimer(RID) {
            refresh = setInterval(function(){
                updateStatus(RID);
            }, 1000);
            return refresh;
        }

        function stopTimer() {
            clearInterval(refresh);
        }

        function chooseDisplay() {
            if ((NormMeth == 2) || (NormMeth == 3)) {
                $("#NormRow").show();
                $("#NormRow-off").hide();
                $("#IterRow").show();
                $("#IterRow-off").hide();
            } else {
                $("#NormRow").hide();
                $("#NormRow-off").show();
                $("#IterRow").hide();
                $("#IterRow-off").show();
            }

            if ((NormMeth == 4) || (NormMeth == 5)) {
                $("#MinRow").show();
                $("#MinRow-off").hide();
            } else {
                $("#MinRow").hide();
                $("#MinRow-off").show();
            }
        }

        function chooseData() {
            if (document.getElementById("NormVal").value < 0) {
                alert("Sample size can only be a positive integer, 'min', 'median', or 'max'");
                return;
            }

            if (document.getElementById("MinVal").value < 0) {
                alert("Sample size can only be a positive integer");
                return;
            }

            if ( ((nodesCat != "") || (nodesQuant != "")) && ((nodesTaxa != "") || (selectAll != 0)) ) {
                $("#run").css("background-color", "yellow");
                $("#container-1").empty().append('Analysis is running...please be patient');
                getCatGraphData();
            } else if ( ((nodesCat == "") || (nodesQuant == "")) && ((nodesTaxa != "") || (selectAll != 0)) ) {
                $("#container-1").empty().append('Please also choose your meta variable(s)!');
                $("#run").css("background-color", "red");
            } else if ( ((nodesCat != "") || (nodesQuant != "")) && ((nodesTaxa == "") || (selectAll == 0)) ) {
                $("#container-1").empty().append('Please also choose your taxa variable(s)!');
                $("#run").css("background-color", "red");
            } else if ( (nodesCat == "") && (nodesQuant == "") && (nodesTaxa == "") && (selectAll == 0) ) {
                $("#container-1").empty().append('Please choose a meta variable(s) and a taxa level(s)!');
                $("#run").css("background-color", "red");
            }
        }

        function searchData() {
            var search = $.map(nodesTaxa, function(node) {
                return node.data.title;
            });
            $("#MicrobeWiki").attr("href", "https://microbewiki.kenyon.edu/index.php/Special:Search?search=" + search);
            $("#Wiki").attr("href", "http://en.wikipedia.org/wiki/" + search);
            $("#Google").attr("href", "http://www.google.com/search?q=" + search);
        }

        function makeGUID(){
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            })
        }

        function getCatGraphData() {
            var RID = makeGUID();
            startTimer(RID);
            var arrayValsCat = [];
            var arrayIDsCat = [];
            var arrayValsQuant = [];
            var arrayIDsQuant = [];
            var key = '';
            var value = '';
            var vals = '';
            var id = '';
            var ids = '';
            for (var i = 0; i < nodesQuant.length; i++) {
                if (nodesQuant[i].getLevel() == 5) {
                    if ((nodesQuant[i].data.table == 'mimark') || (nodesQuant[i].data.table == 'user')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
                else if (nodesQuant[i].getLevel() == 6) {
                    if ((nodesQuant[i].data.table == 'human_associated') || (nodesQuant[i].data.table == 'soil')) {
                        key = nodesQuant[i].data.field;
                        value = nodesQuant[i].data.value;
                        id = nodesQuant[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsQuant.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsQuant.push(ids);
                    }
                }
            }
            for (var i = 0; i < nodesCat.length; i++) {
                if (nodesCat[i].getLevel() == 5) {
                    if ((nodesCat[i].data.table == 'mimark') || (nodesCat[i].data.table == 'user')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
                else if (nodesCat[i].getLevel() == 6) {
                    if ((nodesCat[i].data.table == 'human_associated') || (nodesCat[i].data.table == 'soil')) {
                        key = nodesCat[i].data.field;
                        value = nodesCat[i].data.value;
                        id = nodesCat[i].data.id;
                        vals = '"' + key + '" : "' + value + '"';
                        arrayValsCat.push(vals);
                        ids = '"' + key + '" : "' + id + '"';
                        arrayIDsCat.push(ids);
                    }
                }
            }

            var metaValsCat = '';
            if (nodesCat.length > 0) {
                metaValsCat = "{" + arrayValsCat.join(",") + "}";
            }

            var metaIDsCat = '';
            if (nodesCat.length > 0) {
                metaIDsCat = "{" + arrayIDsCat.join(",") + "}";
            }

            var metaValsQuant = '';
            if (nodesQuant.length > 0) {
                metaValsQuant = "{" + arrayValsQuant.join(",") + "}";
            }

            var metaIDsQuant = '';
            if (nodesQuant.length > 0) {
                metaIDsQuant = "{" + arrayIDsQuant.join(",") + "}";
            }

            var metaVals = '';
            if ((nodesCat.length > 0) && (nodesQuant.length > 0)) {
                metaVals = "{" + arrayValsCat.join(",") + "," + arrayValsQuant.join(",") + "}";
            }
            else if ((nodesCat.length == 0) && (nodesQuant.length > 0)) {
                metaVals = "{" + arrayValsQuant.join(",") + "}";
            }
            else if ((nodesCat.length > 0) && (nodesQuant.length == 0)) {
                metaVals = "{" + arrayValsCat.join(",") + "}";
            }

            var metaIDs = '';
            if ((nodesCat.length > 0) && (nodesQuant.length > 0)) {
                metaIDs = "{" + arrayIDsCat.join(",") + "," + arrayIDsQuant.join(",") + "}";
            }
            else if ((nodesCat.length == 0) && (nodesQuant.length > 0)) {
                metaIDs = "{" + arrayIDsQuant.join(",") + "}";
            }
            else if ((nodesCat.length > 0) && (nodesQuant.length == 0)) {
                metaIDs = "{" + arrayIDsCat.join(",") + "}";
            }

            var array2 = [];
            for (i = 0; i < nodesTaxa.length; i++) {
                key = nodesTaxa[i].data.tooltip;
                value = nodesTaxa[i].data.id;
                if (nodesTaxa[i].getLevel() >= 2) {
                    next = '"' + key + '" : "' + value + '"';
                    array2.push(next);
                }
            }
            var taxa = "{" + array2.join(",") + "}";
            var myDict = {};
            myDict['metaVals'] = metaVals;
            myDict['metaIDs'] = metaIDs;
            myDict['metaValsCat'] = metaValsCat;
            myDict['metaIDsCat'] = metaIDsCat;
            myDict['metaValsQuant'] = metaValsQuant;
            myDict['metaIDsQuant'] = metaIDsQuant;
            myDict['taxa'] = taxa;
            myDict['NormVal'] = document.getElementById("NormVal").value;
            myDict['Iters'] = document.getElementById("Iters").value;
            myDict['MinSize'] = document.getElementById("MinVal").value;
            myDict['selectAll'] = selectAll;
            myDict['NormMeth'] = NormMeth;
            myDict['RID'] = RID;
            var jsonDict = JSON.stringify(myDict);
            $.ajax({
                url: '/getExCatData/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: jsonDict
                },
                success: function(data) {
                    stopTimer(refresh);
                    $('#container-1').empty();
                    var res_table = data['res_table'];
                    $('#res_table').empty().append(res_table).find('.table').DataTable({
                        "jQueryUI": true,
                        "sDom": 'T<"clear">lfrtip',
                        "oTableTools": {
                            "sSwfPath": "{% static "tabletools/swf/copy_csv_xls_pdf.swf" %}"
                        },
                        "bSort": true,
                        "scrollX": true
                    }).draw();

                    var biome = data['biome'];
                    $("#biome-text").empty().append(biome);

                    $("#run").css("background-color", "green");
                }
            });
        }
    </script>
{% endblock javascript %}

{% block my_content %}
    <br>

    <!-- tree tables -->
    <div>
        <table border="2" cellspacing="0" cellpadding="5" class="inlineTable">
            <tr>
                <th>Select Meta Data:<a href="#" id="clearMeta" style="font-size: 12px;">-Deselect all-</a></th>
            </tr>
            <tr>
                <td style="padding-right: 10px; vertical-align: top">
                    <div id="tree_metaCat"></div>
                    <div id="tree_metaQuant"></div>
                </td>
            </tr>
        </table>
        <table border="2" cellspacing="0" cellpadding="5" class="inlineTable" style="margin-left:10px;">
            <tr>
                <th>Select Taxa:<a href="#" id="clearTaxa" style="font-size: 12px;">-Deselect all-</a></th>
            </tr>
            <tr>
                <td style="padding-right: 10px; vertical-align: top">
                    <div id="tree_taxa"></div>
                </td>
            </tr>
        </table>
        <table border="0" cellspacing="0" cellpadding="5"  class="inlineTable">
            <tr>
                <th bgcolor="white"></th>
            </tr>
            <tr>
                <td bgcolor="white">
                    <select id="selectall">
                        <option value="0" selected="selected">Off</option>
                        <option value="2">Phyla</option>
                        <option value="3">Classes</option>
                        <option value="4">Orders</option>
                        <option value="5">Families</option>
                        <option value="6">Genera</option>
                        <option value="7">Species</option>
                    </select>
                    &nbsp<-- Selected taxa level
                </td>
            </tr>
            <tr>
                <td  bgcolor="white">
                    <select id="NormMeth">
                        <option value="1" selected="selected">None</option>
                        <option value="2">Rarefaction (remove)</option>
                        <option value="3">Rarefaction (keep)</option>
                        <option value="4">Proportion</option>
                        <option value="5">DESeq2</option>
                    </select>
                    &nbsp<-- Selected normalization method
                </td>
            </tr>
            <tr>
                <td id="NormRow-off" bgcolor="white"></td>
            </tr>
            <tr>
                <td id="MinRow-off" bgcolor="white"></td>
            </tr>
            <tr>
                <td id="IterRow-off" bgcolor="white"></td>
            </tr>
            <tr>
                <td id="MinRow-off" bgcolor="white"></td>
            </tr>
            <tr>
                <td id="NormRow" style="display: none;" bgcolor="white">
                    <input style="background-color: white" type="text" id="NormVal" value="median"/>
                    &nbsp<-- Subsample size:
                </td>
            </tr>

            <tr>
                <td id="IterRow" style="display: none;" bgcolor="white">
                    <input style="background-color: white" type="text" id="Iters" value="10"/>
                    &nbsp<-- Iterations:
                </td>
            </tr>

            <tr>
                <td id="MinRow" style="display: none;" bgcolor="white">
                    <input style="background-color: white"  type="text" id="MinVal" value="1000"/>
                    &nbsp<-- Minimum sample size:
                </td>
            </tr>

        </table>
    </div>

    <br>
    <div id="stage"></div>
    <div id="container-1" style="height: 40px;"></div>

    <h2>Normalized Data (Tabular):</h2>
    <div id="res_table" style="width: 950px; overflow-x: auto;"></div>

    <br>
    <h2>Normalized Data (Biom Format):</h2>
    <textarea id="biome-text" style="width: 950px;" wrap="off" rows="20"></textarea>
    <br>
    <br>
{% endblock my_content%}


